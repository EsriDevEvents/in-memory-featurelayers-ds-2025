import{nU as q,nV as J,ad as P,fC as Q,nW as _,fS as K,J as j,Q as Y,a6 as Z,nX as ee}from"./index-Dv-JqQDv.js";import{n as A}from"./projectVectorToVector-BbXjU1Ty.js";import{o as te}from"./LayerConstants-B33OP6sh.js";import{t as ne}from"./debugFlags-CfrzpJ7g.js";import{a as U,i as E,o as V,c as ie,s as w,d as L,T as H,e as b,b as re}from"./ElevationProvider-DZcTQ1wD.js";import{N as ae}from"./sphere-j1PWtIhy.js";import{n as se,o as B}from"./Intersector-BLO31d1u.js";import{i as D}from"./Intersector-TO0eVp6c.js";import{w as S}from"./verticalOffsetUtils-DVynISE7.js";class xe extends V{constructor(t,n,i,r){super(n,i),this.point=t,this.createGraphic=r}}function M(e){return U(e)&&e.intersector===E.PCL&&!!e.target}class be extends ie{constructor(t,n,i,r,c){super(t),this.layerUid=t,this.sublayerUid=n,this.nodeIndex=i,this.componentIndex=r,this.triangleNr=c}}class Se extends V{constructor(t,n,i){super(n,null),this.point=t,this.createVoxelGraphic=i}}let Te=class extends V{constructor(t,n){super(t,null),this.createTiles3DGraphic=n}};function x(e){return U(e)&&e.intersector===E.I3S&&!!e.target}function W(e){return U(e)&&e.intersector===E.VOXEL&&!!e.target}function le(e){return U(e)&&e.intersector===E.TILES3D&&!!e.target}function X(e,t){var n,i;return w(e)||L(e)?y((n=e.target)==null?void 0:n.object,t):se(e)?(i=t.map)==null?void 0:i.ground:M(e)||x(e)||B(e)||W(e)?y(e.target,t):null}function De(e,t){const n=N(e,t);return n!=null&&n.type==="graphic"?n.graphic:null}function N(e,t){var n;if(e==null)return null;if(w(e)||L(e))return F((n=e.target)==null?void 0:n.object,t);if(M(e)){const i=e.target.createGraphic();return{type:"graphic",graphic:i,layer:i.layer}}if(W(e)){const i=e.target.createVoxelGraphic();return{type:"graphic",graphic:i,layer:i.layer}}if(le(e)){const i=e.target.createTiles3DGraphic();return{type:"graphic",graphic:i,layer:i.layer}}return B(e)||D(e)?F(e.target,t):x(e)?ce(e.target,t):null}function F(e,t){if((e==null?void 0:e.graphicUid)==null)return null;const n=y(e,t);if(n==null)return null;if(n===t.graphics)return t.graphicsView==null||typeof e.graphicUid!="number"?null:t.graphicsView.getHit(e.graphicUid);const i=t.allLayerViews.find(r=>r.layer===n);return!i||i.suspended||e.graphicUid==null?null:"getHit"in i?i.getHit(e.graphicUid):null}function ce(e,t){const n=y(e,t);if(n==null)return null;const i=t.allLayerViews.find(r=>r.layer===n);return i&&!i.suspended&&"getGraphicFromIntersectorTarget"in i?ue(i.getGraphicFromIntersectorTarget(e)):null}function oe(e,t){const n=y(e,t);if(n==null)return null;const i=t.allLayerViews.find(r=>r.layer===n);return i&&!i.suspended&&"getAABBFromIntersectorTarget"in i?i.getAABBFromIntersectorTarget(e):null}function ue(e){return e!=null?{type:"graphic",graphic:e,layer:e.layer}:null}function y(e,t){return(e==null?void 0:e.layerUid)==null?null:t.graphicsView!=null&&e.layerUid===t.graphicsView.processor.layer.id?t.graphics:t.map.allLayers.find(n=>n.uid===e.layerUid)}function Ne(e,t){if(w(e)||L(e))return ae(e.target.object.boundingVolumeWorldSpace.bounds);if(D(e)){q(I,e.transformation);const n=Math.max(I[0],I[1],I[2]);return e.target.baseBoundingSphere.radius*n}if(x(e)){const n=oe(e.target,t);return n?.5*J(n):null}return null}function Ce(e){return!w(e)&&!L(e)&&(D(e)?e.target.numLodLevels>1:!!x(e))}const I=P();async function Re(e,t,n,i){const r=n?z(e,n):i,c=Q(t.x,t.y);r.requiresGroundFeedback=!0,r.enableDraped=!0;const a=H(e.state.viewingMode);a.options.selectionMode=!0,a.options.store=b.ALL,e.sceneIntersectionHelper.intersectIntersectorScreen(c,a,r);const u=de(e,a.results.all,r.graphics),s=a.results.ground,l=X(s,e),d=l!=null&&"type"in l&&_(l.type)?l:null,o={screenPoint:t,results:u,ground:{mapPoint:f(e,s),distance:U(s)?s.distanceInRenderSpace:0,layer:d}};return ne.SCENEVIEW_HITTEST_RETURN_INTERSECTOR&&(o.intersector=a),o}function Ge(e,t,n,i){var d,o,R,G,v;const r=n?z(e,n):i,c=!(!((d=r.graphics)!=null&&d.include)&&!((o=r.graphics)!=null&&o.exclude)),a=!(!((R=r.mediaElements)!=null&&R.include)&&!((G=r.mediaElements)!=null&&G.exclude)),u=K(t);r.enableDraped=r.include&&!r.include.has(S)||((v=r.exclude)==null?void 0:v.has(S));const s=e.sceneIntersectionHelper,l=H(e.state.viewingMode);if(l.options.selectionMode=!0,l.options.store=c||a?b.ALL:b.MIN,l.options.hud=!(n!=null&&n.excludeHud),s.intersectIntersectorScreen(u,l,r),c||a){for(const $ of l.results.all){const m=N($,e);if(m==null||c&&(m.type!=="graphic"||O(r.graphics,m.graphic))||a&&(m.type!=="media"||k(r.mediaElements,m.element)))return f(e,$)}return null}return f(e,l.results.min)}function de(e,t,n){const i=new Array;let r=null;for(let c=0;c<t.length;c++){const a=t[c],u=X(a,e);if(u!=null&&(u===e.map.ground||"type"in u&&_(u.type)))break;const s=N(a,e);if(s==null)continue;if(s.type==="graphic"){if(r==null&&c!==t.length-1&&(r=new Set),r!=null){const o=C(s.graphic);if(r.has(o))continue;r.add(o)}if(!O(n,s.graphic))continue}const l=f(e,a),d=a.distanceInRenderSpace;if(s.type==="media"){const o=s.element.toSource(l);i.push({...s,mapPoint:l,distance:d,sourcePoint:o})}else i.push({...s,mapPoint:l,distance:d})}return i}function f(e,t,n){return t.getIntersectionPoint(g)?(n=pe(e,g,n),t.intersector===E.TERRAIN&&e.basemapTerrain&&(n.z=re(e.basemapTerrain,n)??0),n):null}function C(e){var r;const t=e.sourceLayer,n=e.layer,i=t&&"objectIdField"in t?t:n&&"objectIdField"in n?n:t;if(i){const c=i.objectIdField??te,a=(r=e.attributes)==null?void 0:r[c];if(a)return`o-${i.id}-${a}`}return`u-${e.uid}`}function O(e,t){return k(e,C(t))}function k(e,t){return e==null||(e.include==null||e.include.has(t))&&(e.exclude==null||!e.exclude.has(t))}function pe(e,t,n){let i=e.spatialReference||j.WGS84;return A(t,e.renderSpatialReference,g,i)?t=g:(i=j.WGS84,A(t,e.renderSpatialReference,g,i)&&(t=g)),n?(n.x=t[0],n.y=t[1],n.z=t[2],n.spatialReference=i):n=new Y(t,i),n}function z(e,t){const n=T(e,t.include,h.INCLUDE),i=T(e,t.exclude,h.EXCLUDE);return{include:n.layerUids,exclude:i.layerUids,graphics:{include:n.graphicUids,exclude:i.graphicUids},mediaElements:{include:n.mediaElements,exclude:i.mediaElements}}}function T(e,t,n,i={layerUids:void 0,graphicUids:void 0,mediaElements:void 0}){if(!t)return i;if(t instanceof Z)fe(i,C(t)),n===h.INCLUDE&&(e.graphicsView!=null&&t.layer===e?p(i,e.graphicsView.processor.layer.id):t.layer&&p(i,t.layer.uid));else if("layer"in t&&"element"in t)ge(i,t.element),n===h.INCLUDE&&p(i,t.layer.uid);else if(ee(t))for(const r of t)r===e.graphics&&e.graphicsView!=null?p(i,e.graphicsView.processor.layer.id):r===e.map.ground?p(i,S):T(e,r,n,i);else"uid"in t&&p(i,t.uid);return i}function p(e,t){e.layerUids||(e.layerUids=new Set),e.layerUids.add(t)}function fe(e,t){e.graphicUids||(e.graphicUids=new Set),e.graphicUids.add(t)}function ge(e,t){e.mediaElements||(e.mediaElements=new Set),e.mediaElements.add(t)}const g=P();var h;(function(e){e[e.INCLUDE=0]="INCLUDE",e[e.EXCLUDE=1]="EXCLUDE"})(h||(h={}));class ve{constructor(t){this._store=t}destroy(){this._store.destroy()}get(t){return this._store.get(t)}put(t,n){this._store.put(t,n,n.values.byteLength+256)}}export{Ge as I,pe as L,z as R,Re as U,Ne as V,x as a,Se as c,Te as l,De as m,be as o,le as p,xe as s,ve as t,Ce as w};
