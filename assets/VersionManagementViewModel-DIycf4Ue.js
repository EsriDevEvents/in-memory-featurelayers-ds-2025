const __vite__fileDeps=["./createVersion-BV8ZeUQI.js","./index-Dv-JqQDv.js","./index-CejX7rzk.css","./CreateVersionParameters-C52OsO1y.js","./deleteVersion-DNakhC-c.js","./serverVersionUtils-D6vaoGkB.js","./DeleteVersionParameters-CH48Zu9a.js","./getVersion-C1SuihgQ.js","./getVersionInfos-0uqVgaYu.js","./GetVersionInfosParameters-2xhH7d7x.js","./reconcile-DAXN56_I.js","./ReconcileParameters-lCPdjT_T.js","./post-AvOUIHLY.js","./PostParameters-DtkWJbCQ.js","./alterVersion-Bk-FmlZZ.js","./AlterVersionParameters-DjxxEHg6.js","./startReading-BQkI4e7e.js","./stopReading-Bjiz89Kk.js","./startEditing-CAdoOvc5.js","./deleteForwardEdits-DNCv9Ozz.js","./DeleteForwardEditsParameters-BuwDad-D.js","./stopEditing-DlxFFszE.js"],__vite__mapDeps=i=>i.map(i=>__vite__fileDeps[i]);
import{ec as W,ee as ye,m as q,ab as Z,X as we,al as _e,c as Ve,F as D,lY as de,b7 as Ee,S as Se,r2 as Ie,r3 as ke,J as ce,O as ee,q as Le,r as be,t as Me,bF as A,bG as xe,bH as Ue,w as E,U,s as h,n5 as te,j as a,y as l,bm as C,P as N,r4 as S,r5 as re,a as Re,ar as k,G as M,qm as he,r6 as g,r7 as O,r8 as Pe,r9 as ie,_ as p,ra as b,kV as Te,eu as De,d$ as Oe,bt as $e,b_ as Ae,o as x,cu as se,C as Ce}from"./index-Dv-JqQDv.js";import{h as ne}from"./UpdatingHandles-C0Kh7aEt.js";import{t as Ne}from"./utils-CUv1brjH.js";import{m as oe,b as Fe,f as He,j as We,y as qe,I as Je}from"./applyEditsUtils-CdvuxNo_.js";import{checkEditingCapabilities as je,normalizeEdits as Ge,normalizeGeometries as Qe}from"./editingSupport-ByWiN5tS.js";import{a as ae}from"./catalogUtils-CiWgGrdS.js";import"./MeshTransform-BahjckjL.js";import"./mat4f64-Dk4dwAN8.js";import"./quat-B52zwwOM.js";import"./mat3f64-BBpwCtoL.js";import"./quatf64-BrpT0VRp.js";import"./axisAngleDegrees-CRhw0Lf9.js";function $(t,e){const r=e.id;return{id:r,name:e.name,url:`${t}/${r}`,type:e.type||"Table"}}function ze(t){return{data:Be(t),sync:Ze(t),operations:Xe(t.capabilities,t),query:Ye(t),editing:Ke(t)}}function Be(t){return{isDataVersioned:S(t,"hasVersionedData",!1)}}function Xe(t,e){const r=t?t.toLowerCase().split(",").map(d=>d.trim()):[],i=r.includes("query"),n=r.includes("editing")&&!e.datesInUnknownTimezone;let s=n&&r.includes("create"),o=n&&r.includes("delete"),u=n&&r.includes("update");return n&&!(s||o||u)&&(s=o=u=!0),{supportsAdd:s,supportsDelete:o,supportsEditing:n,supportsChangeTracking:r.includes("changetracking"),supportsQuery:i,supportsQueryDataElements:S(e,"supportsQueryDataElements",!1),supportsQueryDomains:S(e,"supportsQueryDomains",!1),supportsQueryContingentValues:S(e,"supportsQueryContingentValues",!1),supportsSync:r.includes("sync"),supportsUpdate:u}}function Ye(t){return{maxRecordCountFactor:re(t,"maxRecordCountFactor",void 0),maxRecordCount:re(t,"maxRecordCount",void 0)}}function Ke(t){const e=t==null?void 0:t.advancedEditingCapabilities;return{supportsGlobalId:S(t,"supportsApplyEditsWithGlobalIds",!1),supportsReturnServiceEditsInSourceSpatialReference:S(e,"supportsReturnServiceEditsInSourceSR",!1),supportsSplit:S(e,"supportsSplit",!1),supportsAsyncApplyEdits:S(e,"supportsAsyncApplyEdits",!1)}}function Ze(t){const e=t==null?void 0:t.syncCapabilities,r=e==null?void 0:e.supportedSyncDataOptions;return{supportsAsync:S(e,"supportsAsync",!1),supportedSyncDataOptions:{annotations:!(1&~r),dimensions:!(2&~r),contingentValues:!(4&~r),attributeRules:!(8&~r),utilityNetworkSystem:!(16&~r),annotationFullModel:!(32&~r),include3DObjects:!(64&~r),utilityNetworkMissingLayers:!(128&~r),preserveTrueCurves:!(256&~r)}}}let f=class extends W(ye(q)){constructor(t){super(t),this.url=null,this.sourceJSON=null,this.userHasFullEditingPrivileges=!1,this.userHasUpdateItemPrivileges=!1,this.userTypeExtensions=[],this.layerInfos=null,this.tableInfos=null,this.capabilities=null}read(t,e){this.sourceJSON=t,super.read(t,e)}get utilityNetworkUrl(){if(this.sourceJSON){for(const t of this.sourceJSON.layers)if(t.type==="Utility Network Layer")return`${this.url}/${t.id}`}return null}get versionManagementServiceUrl(){var t;return(t=this.sourceJSON)!=null&&t.hasBranchVersionedData?this.url.replace(/\/FeatureServer/i,"/VersionManagementServer"):null}readLayerInfos(t,e){return(e.layers||[]).map(r=>{const{type:i,geometryType:n}=r;return{...$(this.url,r),type:i||"Feature Layer",geometryType:n}})}readTableInfos(t,e){return(e.tables||[]).map(r=>$(this.url,r))}readCapabilities(t,e){return ze(e)}get effectiveCapabilities(){const t=this.capabilities;if(!t)return null;const e=Z(t),{operations:r}=e;return this.userHasUpdateItemPrivileges?(r.supportsAdd=r.supportsDelete=r.supportsEditing=r.supportsQuery=r.supportsUpdate=!0,e):(this.userHasFullEditingPrivileges&&r.supportsEditing&&(r.supportsAdd=r.supportsDelete=r.supportsUpdate=!0),e)}load(t){return this.addResolvingPromise(this._fetchService(this.url,t).then(()=>this._setUserPrivileges(t))),Promise.resolve(this)}async fetchAllLayersAndTables(t){return await this.load(t),this._fetchLayersAndTablesPromise||(this._fetchLayersAndTablesPromise=this._fetchLayersAndTables(this.url)),we(t),this._fetchLayersAndTablesPromise}async applyEdits(t,e){let r=null;try{const{results:i,edits:n,editedFeatures:s}=await this._internalApplyEdits(t,e),o=d=>d.filter(c=>!c.error).map(Z);let u=0;return i.map(d=>{r=_e(this.url,d.id,e==null?void 0:e.gdbVersion,!0);const c={edits:n[u],addedFeatures:o(d.addFeatureResults),updatedFeatures:o(d.updateFeatureResults),deletedFeatures:o(d.deleteFeatureResults),addedAttachments:o(d.addAttachmentResults),updatedAttachments:o(d.updateAttachmentResults),deletedAttachments:o(d.deleteAttachmentResults),exceededTransferLimit:!1,historicMoment:d.editMoment?new Date(d.editMoment):null};u+=1,s.length>0&&(c.editedFeatures=s),r.resolve(c),r=null}),i}catch(i){throw r&&r.reject(i),i}}async _setUserPrivileges(t){if(Ve.userPrivilegesApplied)try{const{features:{fullEdit:e},content:{updateItem:r}}=await this._fetchUserPrivileges(this.sourceJSON.serviceItemId,t);this._set("userHasFullEditingPrivileges",e),this._set("userHasUpdateItemPrivileges",r)}catch(e){D(e)}}async _fetchUserPrivileges(t,e){var d;if(!t)return{features:{edit:!0,fullEdit:!1},content:{updateItem:!1}};let s,o,u;try{s=await de(this.url,e)}catch(c){D(c)}try{const c=e!=null?e.signal:null;o=await((d=Ee)==null?void 0:d.getCredential(`${s}/sharing`,{prompt:!1,signal:c}))}catch(c){D(c)}if(!o)return{features:{edit:!0,fullEdit:!1},content:{updateItem:!1}};try{if(u=new Se({id:t,portal:{url:s}}),await u.load(e),u.portal.user)return Ie(u)}catch(c){D(c)}return{features:{edit:!0,fullEdit:!1},content:{updateItem:!1}}}async _internalApplyEdits(t,e){await ke(this.url);const r=(e==null?void 0:e.globalIdUsed)??!1,i=ce.fromJSON(this.sourceJSON.spatialReference),{edits:n,options:s}=await this._processApplyEditsParams(t,e),o=await Promise.all(n.map(async _=>{var Y,K;const F=((Y=_.addFeatures)==null?void 0:Y.map(H=>oe({spatialReference:i},H,null)))??[],j=(await Promise.all(F)).filter(ee),G=j.length>0?j:null,ge=((K=_.updateFeatures)==null?void 0:K.map(H=>oe({spatialReference:i},H,null)))??[],Q=(await Promise.all(ge)).filter(ee),z=Q.length>0?Q:null,B=Fe(_.identifierFields,_.deleteFeatures,r),fe=B.length>0?B:null;Le(G,z,i);const I=await He(_.identifierFields,_);let X=null;return I&&(X={adds:I.adds.length>0?I.adds:void 0,updates:I.updates.length>0?I.updates:void 0,deletes:I.deletes.length>0?I.deletes:void 0}),{id:_.id,adds:G,updates:z,deletes:fe,attachments:X}})),u={gdbVersion:s==null?void 0:s.gdbVersion,rollbackOnFailure:!0,useGlobalIds:r,returnEditMoment:!0,honorSequenceOfEdits:s==null?void 0:s.honorSequenceOfEdits,usePreviousEditMoment:s==null?void 0:s.usePreviousEditMoment,returnServiceEditsInSourceSR:!1,returnServiceEditsOption:"originalAndCurrentFeatures",async:!1};await be(this.url,e==null?void 0:e.gdbVersion,!0);const d=Me(this.url,(e==null?void 0:e.gdbVersion)||null);u.edits=JSON.stringify(o);const c=A(this.url),y=xe(c.query,{query:Ue({...u,f:"json"}),method:"post"});let v;d&&(y.authMode="immediate",y.query.sessionId=E);try{v=await U(this.url+"/applyEdits",y)}catch(_){if(!We(_))throw _;y.authMode="immediate",v=await U(this.url+"/applyEdits",y)}return{...et(v),edits:n}}async _processApplyEditsParams(t,e){const r={...e};return{edits:await Promise.all(t.map(async i=>{const n=this.effectiveCapabilities,s=i&&(i.addFeatures||i.updateFeatures||i.deleteFeatures),o=i&&(i.addAttachments||i.updateAttachments||i.deleteAttachments);if(je(i,n,e,!!s,!!o,"feature-service"),!n.data.isDataVersioned&&(e==null?void 0:e.gdbVersion))throw new h("feature-service:invalid-parameter","'gdbVersion' is applicable only if the layer supports versioned data. See: 'capabilities.data.isVersioned'");const u=Ge(i,n,"feature-service");return{...await Qe(u),id:i.id,identifierFields:i.identifierFields}})),options:r}}async _fetchService(t,e){if(this.sourceJSON)return void this.read(this.sourceJSON,{url:A(t)});const r=await U(t,{responseType:"json",query:{f:"json"},...e});this.read(r.data,{url:A(t)})}async _fetchLayersAndTables(t){const e=`${t}/layers`,r=await U(e,{responseType:"json",query:{f:"json"}});return{layers:r.data.layers.map(i=>{const{type:n,geometryType:s}=i,o=$(this.url,i),u=te(i,o.url);return{...o,type:n||"Feature Layer",geometryType:s,capabilities:u}}),tables:r.data.tables.map(i=>{const n=$(this.url,i),s=te(i,n.url);return{...n,capabilities:s}})}}};function et(t){const e=t.data,r=[];return{results:e.map(i=>{const n={addResults:i.addResults??[],updateResults:i.updateResults??[],deleteResults:i.deleteResults??[],attachments:i.attachments,editMoment:i.editMoment},s=qe(n),o=i.editedFeatures,u=o!=null&&o.spatialReference?new ce({wkid:o==null?void 0:o.spatialReference.wkid,wkt:o==null?void 0:o.spatialReference.wkt,latestWkid:o==null?void 0:o.spatialReference.latestWkid,latestVcsWkid:o==null?void 0:o.spatialReference.latestVcsWkid,vcsWkid:o==null?void 0:o.spatialReference.vcsWkid}):null,d=o?Je(o,u):null;return d&&r.push({layerId:i.id,editedFeatures:d}),{id:i.id,editedFeatures:d,...s}}),editedFeatures:r}}a([l()],f.prototype,"url",void 0),a([l()],f.prototype,"sourceJSON",void 0),a([l()],f.prototype,"userHasFullEditingPrivileges",void 0),a([l()],f.prototype,"userHasUpdateItemPrivileges",void 0),a([l({readOnly:!0})],f.prototype,"utilityNetworkUrl",null),a([l({readOnly:!0})],f.prototype,"versionManagementServiceUrl",null),a([l()],f.prototype,"userTypeExtensions",void 0),a([l({json:{read:{source:["layers"]}}})],f.prototype,"layerInfos",void 0),a([C("layerInfos",["layers"])],f.prototype,"readLayerInfos",null),a([l({json:{read:{source:["tables"]}}})],f.prototype,"tableInfos",void 0),a([C("tableInfos",["tables"])],f.prototype,"readTableInfos",null),a([l({readOnly:!0,json:{read:{source:["hasVersionedData","capabilities","supportsQueryDataElements","supportsQueryDomains","supportsQueryContingentValues","maxRecordCountFactor","maxRecordCount","advancedEditingCapabilities","supportsApplyEditsWithGlobalIds","syncCapabilities","datesInUnknownTimezone"]}}})],f.prototype,"capabilities",void 0),a([C("capabilities",["hasVersionedData","capabilities","supportsQueryDataElements","supportsQueryDomains","supportsQueryContingentValues","maxRecordCountFactor","maxRecordCount","advancedEditingCapabilities","supportsApplyEditsWithGlobalIds","syncCapabilities","datesInUnknownTimezone"])],f.prototype,"readCapabilities",null),a([l({readOnly:!0})],f.prototype,"effectiveCapabilities",null),f=a([N("esri.rest.featureService.FeatureService")],f);const J=f,pe=(t,e)=>{for(const r of t)if(r.type==="feature"||r.type==="subtype-group"){if(!r.url)continue;const i=Re(r.url).url.path,n=e.get(i);if(n)n.layers.push(r);else{const s=new J({url:i}),o=[r];e.set(i,{featureService:s,layers:o})}}else r.type==="group"&&pe(r.layers,e)};function tt(t){const e=new Map;return pe(t,e),e}let w=class extends W(q){constructor(e){super(e),this.versionManagementService=null,this.featureServiceUrl=null,this.url=null,this.currentVersion=null,this.currentVersionInfo=null,this.versionInfos=[],this.versionableItems=new k,this.usePersistentReadSessions=!1,this.state="lock-none"}initialize(){this.url=this.versionManagementService.url,this.featureServiceUrl=this.url.replace(/\/VersionManagementServer/i,"/FeatureServer"),this.addHandles([this.versionableItems.on("before-add",e=>{if(e.item.featureServiceUrl.toLowerCase()!==this.featureServiceUrl.toLowerCase())return e.preventDefault(),void M.getLogger(this).error("#add()","Cannot add versionAdapter, feature service urls do not match.")}),this.versionableItems.on("before-remove",e=>{if(this.versionableItems.items.length===0&&this.currentVersion&&"name"in this.currentVersion&&this.versionManagementService.getLockType(this.currentVersion)!=="none")return e.preventDefault(),void M.getLogger(this).error("#remove()","Cannot remove last versionAdapter.")})])}load(e){return this.addResolvingPromise(this._setUpState(e)),Promise.resolve(this)}get defaultVersionIdentifier(){return this.versionManagementService.defaultVersionIdentifier}get isDefault(){return!this.currentVersion||!!this.currentVersion&&"name"in this.currentVersion&&this.currentVersion.name===this.defaultVersionIdentifier.name}async getVersionInfos(e=!1){return e&&(this.versionInfos=await this.versionManagementService.getVersionInfos()),this.versionInfos}async alterVersion(e,r){if(this.currentVersion&&"guid"in this.currentVersion&&e.guid===this.currentVersion.guid)return!1;const i=await this.versionManagementService.alterVersion(e,r);return i&&await this.getVersionInfos(!0),i}async deleteVersion(e){if(this.currentVersion&&"guid"in this.currentVersion&&e.guid===this.currentVersion.guid)return!1;const r=await this.versionManagementService.deleteVersion(e);return r&&await this.getVersionInfos(!0),r}async getVersionInfoExtended(){return this.currentVersion&&"name"in this.currentVersion?this.versionManagementService.getVersionInfoExtended(this.currentVersion):this.versionManagementService.getVersionInfoExtended(this.defaultVersionIdentifier)}async startEditing(){if(this._isDefaultOrHistoricVersion())return{success:!1};if(!this.usePersistentReadSessions){const r=await this.versionManagementService.startReadingWithResult(this.currentVersion);if(!r.success)return r;this.state="lock-read"}const e=await this.versionManagementService.startEditingWithResult(this.currentVersion);return e.success&&(this.state="lock-write"),e}async stopEditing(e){if(this._isDefaultOrHistoricVersion())return{success:!1};const r=await this.versionManagementService.stopEditingWithResult(this.currentVersion,e);if(!r.success)return r;if(this.state="lock-read",!this.usePersistentReadSessions){const i=await this.versionManagementService.stopReadingWithResult(this.currentVersion);return i.success&&(this.state="lock-none"),i}return r}async changeVersion(e){var s;let r=null;if(this.usePersistentReadSessions){if(this._isDefaultOrHistoricVersion(e))e&&"name"in e?(r=await this.versionManagementService.getVersionInfoExtended(e),this.state=(r==null?void 0:r.access)==="public"?"lock-none":"lock-read"):this.state="lock-read";else if(!await this.versionManagementService.startReading(e))throw new h("Failed to acquire read lock for version: "+e);this._isDefaultOrHistoricVersion(this.currentVersion)||await this.versionManagementService.stopReading(this.currentVersion)}const i=await this.versionManagementService.changeVersionWithResult(this.versionableItems,this.currentVersion,e);let n=!1;return i.forEach((o,u)=>{n=n||o.success}),n&&(this.currentVersion=e,this.currentVersionInfo=r||await this.getVersionInfoExtended(),this._isDefaultOrHistoricVersion()?this.currentVersion&&"name"in this.currentVersion?this.state=((s=this.currentVersionInfo)==null?void 0:s.access)==="public"?"lock-none":"lock-read":this.state="lock-read":this.state=this.versionManagementService.getLockType(this.currentVersion)!=="read"?"lock-none":"lock-read"),i}async undo(){return this._isDefaultOrHistoricVersion()?{success:!1}:(this.versionManagementService.undo(this.currentVersion),{success:!0})}async redo(){return this._isDefaultOrHistoricVersion()?{success:!1}:(this.versionManagementService.redo(this.currentVersion),{success:!0})}async _setUpState(e){var r;await this.versionManagementService.load(e),this.state="lock-none",this.currentVersionInfo=await this.getVersionInfoExtended(),this.versionableItems.forEach(i=>{this.currentVersion?"name"in this.currentVersion?(i.gdbVersion=this.currentVersion.name,i.historicMoment=null):(i.historicMoment=this.currentVersion,i.gdbVersion=null):(i.gdbVersion=null,i.historicMoment=null)}),this.usePersistentReadSessions&&(this._isDefaultOrHistoricVersion()?this.currentVersion&&"name"in this.currentVersion?this.state=((r=this.currentVersionInfo)==null?void 0:r.access)==="public"?"lock-none":"lock-read":this.state="lock-read":await this.versionManagementService.startReading(this.currentVersion)&&(this.state="lock-read"))}_isDefaultOrHistoricVersion(e=this.currentVersion){return!(e&&"name"in e)||e.name===this.versionManagementService.defaultVersionIdentifier.name}};a([l()],w.prototype,"versionManagementService",void 0),a([l()],w.prototype,"featureServiceUrl",void 0),a([l()],w.prototype,"url",void 0),a([l()],w.prototype,"currentVersion",void 0),a([l()],w.prototype,"currentVersionInfo",void 0),a([l()],w.prototype,"versionInfos",void 0),a([l()],w.prototype,"versionableItems",void 0),a([l()],w.prototype,"usePersistentReadSessions",void 0),a([l()],w.prototype,"state",void 0),a([l({readOnly:!0})],w.prototype,"defaultVersionIdentifier",null),a([l({readOnly:!0})],w.prototype,"isDefault",null),w=a([N("esri.versionManagement.VersioningState")],w);const me=w;let rt=class{constructor(e){this.moments=[],this.forwardMoments=[],this.moments.push(e)}push(e){return this.forwardMoments.length,this.moments.push(e)}pop(){if(!(this.forwardMoments.length>0))return this.moments.pop()}undo(){if(!this.canUndo())return;const e=this.moments.pop();return this.forwardMoments.push(e),e}peek(){return this.moments.at(-1)}canUndo(){return this.moments.length>1}canRedo(){return this.hasForwardEdits()}redo(){if(!this.canRedo())return;const e=this.forwardMoments.pop();return this.moments.push(e),e}size(){return this.moments.length+this.forwardMoments.length}hasForwardEdits(){return this.forwardMoments.length>0}clearForwardEdits(){this.forwardMoments=[]}},R=class{constructor(e){this.versionableItem=e,this.type="featureLayer"}get gdbVersion(){return this.versionableItem.gdbVersion}set gdbVersion(e){this.versionableItem.gdbVersion=e}get historicMoment(){return this.versionableItem.historicMoment}set historicMoment(e){this.versionableItem.historicMoment=e}get featureServiceUrl(){const e=/^(.*\/FeatureServer)\/\d+$/;return this.versionableItem.url.replace(e,"$1")}};a([l({readOnly:!0})],R.prototype,"type",void 0),a([l()],R.prototype,"gdbVersion",null),a([l({type:Date})],R.prototype,"historicMoment",null),a([l({readOnly:!0})],R.prototype,"featureServiceUrl",null);let P=class{constructor(e){this.versionableItem=e,this.type="network"}get gdbVersion(){return this.versionableItem.gdbVersion}set gdbVersion(e){this.versionableItem.gdbVersion=e}get historicMoment(){return this.versionableItem.historicMoment}set historicMoment(e){this.versionableItem.historicMoment=e}get featureServiceUrl(){return this.versionableItem.featureServiceUrl}};a([l({readOnly:!0})],P.prototype,"type",void 0),a([l()],P.prototype,"gdbVersion",null),a([l({type:Date})],P.prototype,"historicMoment",null),a([l({readOnly:!0})],P.prototype,"featureServiceUrl",null);class T{constructor(e){this.versionableItem=e,this.type="subtypeGroupLayer"}get gdbVersion(){return this.versionableItem.gdbVersion}set gdbVersion(e){this.versionableItem.gdbVersion=e}get historicMoment(){return this.versionableItem.historicMoment}set historicMoment(e){this.versionableItem.historicMoment=e}get featureServiceUrl(){const e=/^(.*\/FeatureServer)\/\d+$/;return this.versionableItem.url.replace(e,"$1")}}a([l({readOnly:!0})],T.prototype,"type",void 0),a([l()],T.prototype,"gdbVersion",null),a([l({type:Date})],T.prototype,"historicMoment",null),a([l({readOnly:!0})],T.prototype,"featureServiceUrl",null);function ue(t){return"networkServiceUrl"in t?new P(t):t.type!=="feature"||ae(t)?t.type!=="subtype-group"||ae(t)?null:new T(t):new R(t)}function L(t){const e=[];for(const r of t)if(r.type==="group"){const i=r,n=i.allTables.concat(i.allLayers);for(const s of n)if(s.type==="feature"||s.type==="subtype-group"){const o=ue(s);o&&e.push(o)}}else{const i=ue(r);i&&e.push(i)}return e}let V=class extends W(q){constructor(t){super(t),this.url=null,this.sourceJSON=null,this.name=null,this.defaultVersionIdentifier=null,this.capabilities=null,this._isDefault=e=>!e||e===this.defaultVersionIdentifier.name,this._dateEquals=(e,r)=>!e&&!r||!(!e||!r)&&e.toISOString()===r.toISOString(),this._applyEditsHandler=e=>{const{serviceUrl:r,gdbVersion:i,result:n}=e;r===this._featureServiceUrl&&n.then(s=>{const o=s.historicMoment;o&&this._addMomentToVersionItem(i,o)})}}initialize(){this.url=he(this.url),this._featureServiceUrl=this.url.replace(/\/VersionManagementServer/i,"/FeatureServer"),g.has(this.url)||g.set(this.url,new Map);const t=(O.get(this.url)??0)+1;O.set(this.url,t),this.when().then(()=>this.addHandles(Pe(this._applyEditsHandler)),()=>{})}destroy(){const t=(O.get(this.url)??1)-1;O.set(this.url,t),t===0&&g.delete(this.url),ie.delete(this._featureServiceUrl)}read(t,e){this.sourceJSON=t,super.read(t,e)}readDefaultVersionIdentifier(t,e){return{name:e.defaultVersionName,guid:e.defaultVersionGuid}}writeDefaultVersionIdentifier(t,e){e.defaultVersionName=t.name,e.defaultVersionGuid=t.guid}load(t){return this.addResolvingPromise(this._fetchService(this.url,t)),Promise.resolve(this)}async createVersion(t){const[{createVersion:e},{default:r}]=await Promise.all([p(()=>import("./createVersion-BV8ZeUQI.js"),__vite__mapDeps([0,1,2]),import.meta.url),p(()=>import("./CreateVersionParameters-C52OsO1y.js"),__vite__mapDeps([3,1,2]),import.meta.url)]),i=r.from(t);return e(this.url,i)}async deleteVersion(t){var s;const[{deleteVersion:e},{default:r}]=await Promise.all([p(()=>import("./deleteVersion-DNakhC-c.js"),__vite__mapDeps([4,1,2,5]),import.meta.url),p(()=>import("./DeleteVersionParameters-CH48Zu9a.js"),__vite__mapDeps([6,1,2]),import.meta.url)]);let i;t.guid&&((s=g.get(this.url))!=null&&s.has(t.guid))&&(i=E??void 0);const n=new r({versionName:t.name,sessionId:i});return e(this.url,n)}async getVersionInfoExtended(t){const{getVersion:e}=await p(()=>import("./getVersion-C1SuihgQ.js"),__vite__mapDeps([7,1,2]),import.meta.url);return e(this.url,t.guid)}async getVersionInfos(t={}){const[{getVersionInfos:e},{default:r}]=await Promise.all([p(()=>import("./getVersionInfos-0uqVgaYu.js"),__vite__mapDeps([8,1,2]),import.meta.url),p(()=>import("./GetVersionInfosParameters-2xhH7d7x.js"),__vite__mapDeps([9,1,2]),import.meta.url)]),i=r.from(t);return e(this.url,i)}async reconcile(t,e={}){const[{reconcile:r},{default:i}]=await Promise.all([p(()=>import("./reconcile-DAXN56_I.js"),__vite__mapDeps([10,1,2,5]),import.meta.url),p(()=>import("./ReconcileParameters-lCPdjT_T.js"),__vite__mapDeps([11,1,2]),import.meta.url)]),n=i.from(e);return n.sessionId=E,r(this.url,t.guid,n)}async post(t){const[{post:e},{default:r}]=await Promise.all([p(()=>import("./post-AvOUIHLY.js"),__vite__mapDeps([12,1,2,5]),import.meta.url),p(()=>import("./PostParameters-DtkWJbCQ.js"),__vite__mapDeps([13,1,2]),import.meta.url)]),i=r.from({sessionId:E});return e(this.url,t.guid,i)}async alterVersion(t,e){const[{alterVersion:r},{default:i}]=await Promise.all([p(()=>import("./alterVersion-Bk-FmlZZ.js"),__vite__mapDeps([14,1,2,5]),import.meta.url),p(()=>import("./AlterVersionParameters-DjxxEHg6.js"),__vite__mapDeps([15,1,2]),import.meta.url)]),n=i.from(e);return r(this.url,t.guid,n)}async startReading(t){return(await this.startReadingWithResult(t)).success}async startReadingWithResult(t){const{startReading:e}=await p(()=>import("./startReading-BQkI4e7e.js"),__vite__mapDeps([16,1,2]),import.meta.url),r=await e(this.url,t.guid,E);if(r.success){const i=await this.getVersionInfoExtended(t),n=new Date(i.modifiedDate),s={name:i.versionIdentifier.name,moment:n,lockType:"read"};this._addOrUpdateItem(t.guid,s),b(this._featureServiceUrl,null,t.name,n)}return r}async stopReading(t){return(await this.stopReadingWithResult(t)).success}async stopReadingWithResult(t){var i;const{stopReading:e}=await p(()=>import("./stopReading-Bjiz89Kk.js"),__vite__mapDeps([17,1,2]),import.meta.url),r=await e(this.url,t.guid,E);return r.success&&((i=g.get(this.url))==null||i.delete(t.guid),b(this._featureServiceUrl,null,t.name,null)),r}async startEditing(t){return(await this.startEditingWithResult(t)).success}async startEditingWithResult(t){const{startEditing:e}=await p(()=>import("./startEditing-CAdoOvc5.js"),__vite__mapDeps([18,1,2]),import.meta.url),r=await e(this.url,t.guid,E);if(r.success){const i=await this.getVersionInfoExtended(t),n=new Date(i.modifiedDate),s=new rt(n),o={name:t.name,moment:n,lockType:"edit",stack:s};this._addOrUpdateItem(t.guid,o),b(this._featureServiceUrl,null,t.name,n)}return r}async stopEditing(t,e){return(await this.stopEditingWithResult(t,e)).success}async stopEditingWithResult(t,e){var n,s;if(e){const o=(n=g.get(this.url))==null?void 0:n.get(t.guid);if((s=o==null?void 0:o.stack)!=null&&s.canRedo()){const[{deleteForwardEdits:u},{default:d}]=await Promise.all([p(()=>import("./deleteForwardEdits-DNCv9Ozz.js"),__vite__mapDeps([19,1,2]),import.meta.url),p(()=>import("./DeleteForwardEditsParameters-BuwDad-D.js"),__vite__mapDeps([20,1,2]),import.meta.url)]),c=await u(this.url,t.guid,new d({sessionId:E,moment:o.moment}));if(!c.success)return c}}const{stopEditing:r}=await p(()=>import("./stopEditing-DlxFFszE.js"),__vite__mapDeps([21,1,2]),import.meta.url),i=await r(this.url,t.guid,E,e);if(i.success){const o=await this.getVersionInfoExtended(t),u=new Date(o.modifiedDate);this._addOrUpdateItem(t.guid,{name:t.name,moment:u,lockType:"read",editMomentStack:void 0}),b(this._featureServiceUrl,null,t.name,u)}return i}getLockType(t){var r,i;return((i=(r=g.get(this.url))==null?void 0:r.get(t.guid))==null?void 0:i.lockType)??"none"}async changeVersion(t,e,r){if(r&&"name"in r&&!await this.getVersionInfoExtended(r))throw new h("version-management-service:invalid-version","version does not exist");if("networkServiceUrl"in t){if(this._featureServiceUrl.toLowerCase()===t.featureServiceUrl.toLowerCase())return this._changeVersionInternal(t,e,r)}else{let i;"layers"in t?(i=t.allTables.concat(t.allLayers),t.utilityNetworks&&t.utilityNetworks.forEach(n=>{this._featureServiceUrl.toLowerCase()===n.featureServiceUrl.toLowerCase()&&this._changeVersionInternal(n,e,r)})):i=t;for(const n of i)if(n.type==="feature"||n.type==="subtype-group"){const s=/^(.*\/FeatureServer)\/\d+$/,o=n.url.replace(s,"$1");if(this._featureServiceUrl.toLowerCase()===o.toLowerCase()&&!this._changeVersionInternal(n,e,r))return!1}else if(n.type==="group"){const s=n.allTables.concat(n.allLayers);for(const o of s)if(o.type==="feature"||o.type==="subtype-group"){const u=/^(.*\/FeatureServer)\/\d+$/,d=o.url.replace(u,"$1");if(this._featureServiceUrl.toLowerCase()===d.toLowerCase()&&!this._changeVersionInternal(o,e,r))return!1}}}return!0}async changeVersionWithResult(t,e,r){let i;if("layers"in t){const s=L(t.allTables.concat(t.allLayers).filter(o=>o.type!=="group").toArray());t.utilityNetworks&&t.utilityNetworks.forEach(o=>{const u=L([o]);s.push(...u)}),i=s}else i=t;if(r&&"name"in r&&!await this.getVersionInfoExtended(r)){const s=new Map;for(const o of i)s.set(o,{success:!1});return s}if(e&&"name"in e&&this.getLockType(e)!=="none"){const s=new Map;for(const o of i)s.set(o,{success:!1});return s}const n=new Map;for(const s of i)if(s)if(s.featureServiceUrl.toLowerCase()===this._featureServiceUrl.toLowerCase()){const o=this._changeVersionInternalWithResult(s,e,r);n.set(s,o)}else n.set(s,{success:!1});return n}async getVersionIdentifierFromName(t){var e;try{return((e=(await this.getVersionInfos({includeHidden:!0})).find(i=>i.versionIdentifier.name===t))==null?void 0:e.versionIdentifier)||null}catch{return null}}async getVersionIdentifierFromGuid(t){const{getVersion:e}=await p(()=>import("./getVersion-C1SuihgQ.js"),__vite__mapDeps([7,1,2]),import.meta.url);try{return(await e(this.url,t)).versionIdentifier}catch{return null}}canUndo(t){var r,i;const e=(r=g.get(this.url))==null?void 0:r.get(t.guid);return!!((i=e==null?void 0:e.stack)!=null&&i.canUndo())}canRedo(t){var r,i;const e=(r=g.get(this.url))==null?void 0:r.get(t.guid);return!!((i=e==null?void 0:e.stack)!=null&&i.canRedo())}undo(t){var i,n,s;const e=(i=g.get(this.url))==null?void 0:i.get(t.guid),r=((n=e==null?void 0:e.stack)==null?void 0:n.undo())||void 0;if(e&&r){const o=e.stack.peek();b(this._featureServiceUrl,null,t.name,o),(s=g.get(this.url))==null||s.set(t.guid,{...e,moment:o})}}redo(t){var i,n,s;const e=(i=g.get(this.url))==null?void 0:i.get(t.guid),r=((n=e==null?void 0:e.stack)==null?void 0:n.redo())||void 0;e&&r&&(b(this._featureServiceUrl,null,t.name,r),(s=g.get(this.url))==null||s.set(t.guid,{...e,moment:r}))}_setUpData(t,e){let r=null,i=null,n=null,s=null;const o=u=>{var c,y;const d=(y=(c=g)==null?void 0:c.get(this.url))==null?void 0:y.get(u.guid);n=u.name,s=(d==null?void 0:d.moment)??null};if(t&&"name"in t){if(this.getLockType(t)!=="none")throw new h("version-management-service:version-locked","version is locked");r=t.name,i=null,e&&"name"in e?o(e):(n=this.defaultVersionIdentifier.name,s=e)}else r=this.defaultVersionIdentifier.name,i=t,e&&"name"in e?o(e):(n=this.defaultVersionIdentifier.name,s=e);return{fromVersionName:r,fromMoment:i,toVersionName:n,toMoment:s}}_changeVersionInternal(t,e,r){try{const{fromVersionName:i,fromMoment:n,toVersionName:s,toMoment:o}=this._setUpData(e,r);(this._isDefault(i)&&this._isDefault(t.gdbVersion)&&this._dateEquals(t.historicMoment,n)||i===t.gdbVersion&&this._dateEquals(t.historicMoment,n))&&(t.gdbVersion=s,t.historicMoment=o)}catch{return!1}return!0}_changeVersionInternalWithResult(t,e,r){try{const{fromVersionName:i,fromMoment:n,toVersionName:s,toMoment:o}=this._setUpData(e,r);return this._isDefault(i)&&this._isDefault(t.gdbVersion)&&this._dateEquals(t.historicMoment,n)||i===t.gdbVersion&&this._dateEquals(t.historicMoment,n)?(t.gdbVersion=s,t.historicMoment=o,{success:!0}):{success:!1}}catch{return{success:!1}}}_addMomentToVersionItem(t,e){const r=g.get(this.url);if(r)for(const[i,n]of r)n.name===t&&this._addToStack(i,e)}_addToStack(t,e){const r=g.get(this.url),i=r==null?void 0:r.get(t);return!!(i!=null&&i.stack)&&(it(i.stack.peek(),e)&&i.stack.push(e),r.set(t,{...i,moment:e}),!0)}_addOrUpdateItem(t,e){const r=g.get(this.url),i=r==null?void 0:r.get(t);return i?(r.set(t,{...i,...e}),!0):!(!e.name||!e.lockType)&&(r==null||r.set(t,{...e,lockType:e.lockType}),!0)}async _fetchService(t,e){if(this.sourceJSON){this.read(this.sourceJSON,{origin:"service",url:A(t)});const i=new Te(this.url).host;return void ie.set(i,this.defaultVersionIdentifier.name)}const r=await U(t,{responseType:"json",query:{f:"json"},...e});this.read(r.data)}};function it(t,e){return t?t.getTime()<e.getTime():!0}a([l()],V.prototype,"url",void 0),a([l()],V.prototype,"sourceJSON",void 0),a([l({type:String,json:{write:!0}})],V.prototype,"name",void 0),a([l({json:{write:{target:{defaultVersionName:{type:String},defaultVersionGuid:{type:String}}},read:{source:["defaultVersionName","defaultVersionGuid"]}}})],V.prototype,"defaultVersionIdentifier",void 0),a([C("defaultVersionIdentifier",["defaultVersionName","defaultVersionGuid"])],V.prototype,"readDefaultVersionIdentifier",null),a([De("defaultVersionIdentifier",{defaultVersionName:{type:String},defaultVersionGuid:{type:String}})],V.prototype,"writeDefaultVersionIdentifier",null),a([l({json:{write:!0}})],V.prototype,"capabilities",void 0),V=a([N("esri.versionManagement.VersionManagementService")],V);const ve=V;async function st(t,e){let r;if("layers"in t){const s=L(t.allTables.concat(t.allLayers).filter(o=>o.type!=="group").toArray());t.utilityNetworks&&t.utilityNetworks.forEach(o=>{const u=L([o]);s.push(...u)}),r=s}else r=new k(t);const i=new Map;for(const s of r){const o=i.get(s.featureServiceUrl);o?o.push(s):i.set(s.featureServiceUrl,new k([s]))}const n=new k;for(const[s,o]of i){const u=new J({url:s});if(await u.load(),!u.versionManagementServiceUrl)continue;const d=new ve({url:u.versionManagementServiceUrl});n.push(new me({versionManagementService:d,versionableItems:o,usePersistentReadSessions:e}))}return n}const le=new Map;async function nt(t,e=!1){const r=await st(t.map,e);return Oe(le,t,()=>(t.addHandles($e(()=>{le.delete(t),r.forEach(i=>i.destroy())})),r.forEach(i=>i.load().catch(n=>{M.getLogger("esri.versionManagement.VersioningState").error("Failed to load Versioning State",n)})),r))}let m=class extends Ae{constructor(t){super(t),this._portalLookup=new Map,this._updatingHandlesLoad=new ne,this._updatingHandlesExecute=new ne,this.advancedEditingUserTypeExtensionLookup=new Map,this.executionError=void 0,this.featureServiceLookup=new Map,this.loadError=void 0,this.serverVersionLookup=new Map,this.serviceNameLookup=new Map,this.userLookup=new Map,this.versionIdentifierLookup=new Map,this.versionInfoLookup=new Map,this.versionManagementServiceLookup=new Map,this.versioningStateLookup=new Map,this.view=null,this.versioningStates=null}initialize(){this._viewChangeHandle(),this.addHandles([x(()=>this.view,()=>{this._resetAllLookupProperties(),this._viewChangeHandle()}),x(()=>this.versioningStates,()=>{this._resetVersioningLookupProperties(),this._setVersioningStatesLookups()})])}destroy(){this._updatingHandlesLoad.destroy(),this._updatingHandlesExecute.destroy()}get state(){return this._updatingHandlesLoad.updating?"loading":this.loadError?"disabled":this._updatingHandlesExecute.updating?"executing":this.executionError?"failed":"ready"}async alterVersion(t){return this._updatingHandlesExecute.addPromise(this._alterVersionInternal(t))}async changeVersion(t,e,r){return this._updatingHandlesExecute.addPromise(this._changeVersionInternal(t,e,r))}async createVersion(t){return this._updatingHandlesExecute.addPromise(this._createVersionInternal(t))}async deleteVersion(t,e,r){return this._updatingHandlesExecute.addPromise(this._deleteVersionInternal(t,e,r))}async getVersionInfos(t){return this._updatingHandlesExecute.addPromise(this._getVersionInfosInternal(t))}async _alterVersionInternal(t){if(this.state==="disabled")throw this._logError("version-management-view-model:load-error",this.loadError),new h("version-management-view-model:load-error",this.loadError);this._setExecutionError();const e=this.versioningStateLookup.get(t.featureServerUrl);if(!e)throw this._logError("version-management-view-model:execution-error","no-versioning-state-found"),new h("version-management-view-model:execution-error",this.executionError);if(!this.serverVersionLookup.has(t.featureServerUrl)||this.serverVersionLookup.get(t.featureServerUrl)<=11.1)throw this._logError("version-management-view-model:execution-error","no-valid-enterprise-version"),new h("version-management-view-model:execution-error",this.executionError);if(!this.advancedEditingUserTypeExtensionLookup.get(t.featureServerUrl))throw this._logError("version-management-view-model:execution-error","no-advanced-editing-user-type-extension"),new h("version-management-view-model:execution-error",this.executionError);const{featureServerUrl:r,versionIdentifier:i,...n}=t,s=await e.alterVersion(i,n).catch(o=>{throw this._logExecutionError(o),o});return await this.getVersionInfos(r),s}async _changeVersionInternal(t,e,r){if(this.state==="disabled")throw this._logError("version-management-view-model:load-error",this.loadError),new h("version-management-view-model:load-error",this.loadError);this._setExecutionError();const i=this.versioningStateLookup.get(t);if(!i)throw this._logError("version-management-view-model:execution-error","no-versioning-state-found"),new h("version-management-view-model:execution-error",this.executionError);const n={name:e,guid:r};return await i.changeVersion(n).catch(s=>{throw this._logExecutionError(s),s})}_updateVersionableItems(t){this._updatingHandlesLoad.addPromise((async()=>{L(t.added).forEach(e=>{const r=e.featureServiceUrl,i=this.versioningStateLookup.get(r);i&&(i.versionableItems.find(n=>n.versionableItem===e.versionableItem)||i.versionableItems.add(e))}),L(t.removed).forEach(e=>{const r=e.featureServiceUrl,i=this.versioningStateLookup.get(r);if(!i)return void this._logError("version-management-view-model:execution-error","no-version-management-service-found");const n=i.versionableItems.find(s=>s.versionableItem===e.versionableItem);n&&i.versionableItems.remove(n)})})())}async _createVersionInternal(t){var d,c,y;if(this.state==="disabled")throw this._logError("version-management-view-model:load-error",this.loadError),new h("version-management-view-model:load-error",this.loadError);this._setExecutionError();const e=t.featureServerUrl,r=this.versioningStateLookup.get(e);if(!r)throw this._logError("version-management-view-model:execution-error","no-versioning-state-found"),new h("version-management-view-model:execution-error",this.executionError);const i=this.advancedEditingUserTypeExtensionLookup.get(t.featureServerUrl),n=this.userLookup.get(e).toUpperCase(),s=this._isEmptyString(t.ownerName)?n:(d=t.ownerName)==null?void 0:d.trim().toUpperCase();if(s!==n){if(this.serverVersionLookup.get(e)<=11.1)throw this._logError("version-management-view-model:execution-error","versioning-api-error"),new h("version-management-view-model:execution-error",this.executionError);if(!i)throw this._logError("version-management-view-model:execution-error","no-advanced-editing-user-type-extension"),new h("version-management-view-model:execution-error",this.executionError)}let o=await((c=this.versioningStateLookup.get(e))==null?void 0:c.getVersionInfos());if((s==null?void 0:s.toUpperCase())==="SDE"&&t.versionName.toUpperCase()==="DEFAULT"||o!=null&&o.find(v=>v.versionIdentifier.name.toUpperCase()===(s+"."+t.versionName).toUpperCase()||v.versionIdentifier.name.toUpperCase()===(n+"."+t.versionName).toUpperCase()))throw this._logError("version-management-view-model:execution-error","no-valid-version-name"),new h("version-management-view-model:execution-error",this.executionError);const u=await r.versionManagementService.createVersion({versionName:t.versionName,access:s!==n?"public":t.access,description:t.description}).catch(v=>{throw this._logExecutionError(v),v});if(s!==n){const{guid:v,name:_}=u.versionIdentifier,F={featureServerUrl:e,versionIdentifier:{guid:v,name:_},access:t.access,ownerName:s};await this.alterVersion(F)||this.deleteVersion(e,n+"."+t.versionName,u.versionIdentifier.guid)}return await this.getVersionInfos(e),o=await((y=this.versioningStateLookup.get(e))==null?void 0:y.getVersionInfos()),o==null?void 0:o.find(v=>v.versionIdentifier.guid===u.versionIdentifier.guid)}async _deleteVersionInternal(t,e,r){if(this.state==="disabled")throw this._logError("version-management-view-model:load-error",this.loadError),new h("version-management-view-model:load-error",this.loadError);this._setExecutionError();const i=this.versioningStateLookup.get(t);if(!i)throw this._logError("version-management-view-model:execution-error","no-versioning-state-found"),new h("version-management-view-model:execution-error",this.executionError);if(this.serverVersionLookup.get(t)<=11.1)throw this._logError("version-management-view-model:execution-error","versioning-api-error"),new h("version-management-view-model:execution-error",this.executionError);if(!this.advancedEditingUserTypeExtensionLookup.get(t))throw this._logError("version-management-view-model:execution-error","no-advanced-editing-user-type-extension"),new h("version-management-view-model:execution-error",this.executionError);const n={name:e,guid:r};return await i.deleteVersion(n).catch(s=>{throw this._logExecutionError(s),new h("version-management-view-model:execution-error",this.executionError)})}async _getVersionInfosInternal(t){var s,o;if(this.state==="disabled")throw this._logError("version-management-view-model:load-error",this.loadError),new h("version-management-view-model:load-error",this.loadError);this._setExecutionError();const e=(s=this.featureServiceLookup.get(t))==null?void 0:s.featureService;if(!e)throw this._logError("version-management-view-model:execution-error","no-feature-service-found"),new h("version-management-view-model:execution-error",this.executionError);e.loaded||await e.load().catch(u=>{throw this._logExecutionError(u),u});const r=e.url;this.serverVersionLookup.set(r,((o=e.sourceJSON)==null?void 0:o.currentVersion)??0),this.serverVersionLookup.get(r)<=11.1&&this.advancedEditingUserTypeExtensionLookup.set(r,!1);const i=this.userLookup.get(t);this._portalLookup.get(t)&&i?this.advancedEditingUserTypeExtensionLookup.set(r,await Ne(this._portalLookup.get(t),i,"advediting")):this.advancedEditingUserTypeExtensionLookup.set(r,!1);const n=this.versioningStateLookup.get(t);if(!n)throw this._logError("version-management-view-model:execution-error","no-versioning-state-found"),new h("version-management-view-model:execution-error",this.executionError);return n.loaded||await n.load().catch(u=>{throw this._logExecutionError(u),u}),await n.getVersionInfos(!0).catch(u=>{throw this._logExecutionError(u),u})}_isEmptyString(t){return!t||t.trim().length===0}_logError(t,e){switch(M.getLogger(this).error(new h(t,e)),t){case"version-management-view-model:load-error":this._setLoadError(e);break;case"version-management-view-model:execution-error":this._setExecutionError(e)}}_logExecutionError(t){this._logError("version-management-view-model:execution-error",t.message)}async _viewChangeHandle(){this._updatingHandlesLoad.addPromise((async()=>{if(this._setLoadError(),!this.view)return void this._setLoadError("no-view-property");if(this.view&&this.view.type!=="2d")return void this._logError("version-management-view-model:load-error","sceneView-not-supported");this.removeHandles("map-change-handle"),this.addHandles([x(()=>{var e;return(e=this.view)==null?void 0:e.map},()=>{this._resetAllLookupProperties(),this._mapChangeHandle(this.versioningStates)})],"map-change-handle");const t=await this._getVersioningStates();await this._mapChangeHandle(t)})())}async _mapChangeHandle(t){this._updatingHandlesLoad.addPromise((async()=>{this._setLoadError(),this.removeHandles("map-layers-tables-change-handle"),this.addHandles([se(()=>{var e;return(e=this.view)==null?void 0:e.map.allLayers},"change",e=>{(e.added.some(({type:r})=>r==="feature")||e.removed.some(({type:r})=>r==="feature")||e.added.some(({type:r})=>r==="subtype-group")||e.removed.some(({type:r})=>r==="subtype-group"))&&(this._resetServiceRelatedLookupProperties(),this._propertiesChangeInternal(this.versioningStates),this._updateVersionableItems(e))}),se(()=>{var e;return(e=this.view)==null?void 0:e.map.allTables},"change",e=>{(e.added.some(({type:r})=>r==="feature")||e.removed.some(({type:r})=>r==="feature")||e.added.some(({type:r})=>r==="subtype-group")||e.removed.some(({type:r})=>r==="subtype-group"))&&(this._resetServiceRelatedLookupProperties(),this._propertiesChangeInternal(this.versioningStates),this._updateVersionableItems(e))})],"map-layers-tables-change-handle"),await this._propertiesChangeInternal(t)})())}async _propertiesChangeInternal(t){this._updatingHandlesLoad.addPromise((async()=>{var n;const e=s=>s.type==="feature",{allLayers:r,allTables:i}=this.view.map;if(this._setLoadError(),this.featureServiceLookup=tt([...r.filter(e),...i.filter(e)]),this.featureServiceLookup.size){this._updateFeatureServiceLookup(t),this.serviceNameLookup=new Map;for(const s of this.featureServiceLookup.values()){const{featureService:o,featureService:{url:u}}=s;if(!this.serviceNameLookup.has(u)){if(o.loaded||await o.load().catch(v=>{M.getLogger(this).error(v)}),!o.versionManagementServiceUrl){this.featureServiceLookup.delete(u);continue}const d=await de(u),c=new Ce({authMode:"immediate",url:d});await c.load().catch(v=>{M.getLogger(this).error(v)});const y=(n=c.user)==null?void 0:n.username;if(!o.loaded||!c.loaded||!y)continue;this.serviceNameLookup.set(he(u),u.split("/").at(-2)),this.userLookup.set(u,y),this._portalLookup.set(u,c)}}this.removeHandles("versioning-states-change-handle"),t.forEach(s=>this._handleVersioningStateLookupUpdate(s)),await this._updateVersioningStates(t),this.versioningStates=t}else this._logError("version-management-view-model:load-error","no-feature-services")})())}_updateFeatureServiceLookup(t){for(const e of t){const r=e.featureServiceUrl;if(!this.featureServiceLookup.has(r)){const i=new J({url:r}),n=e.versionableItems.toArray().flatMap(s=>s.type==="network"?null:s.versionableItem);this.featureServiceLookup.set(r,{featureService:i,layers:n})}}}async _updateVersioningStates(t){for(const e of this.featureServiceLookup.values()){const r=e.featureService;if(r.versionManagementServiceUrl){if(!t.find(i=>i.featureServiceUrl===r.url)&&r.versionManagementServiceUrl){const i=new k(L(e.layers)),n=new me({versionManagementService:new ve({url:r.versionManagementServiceUrl}),versionableItems:i});t.add(n),this._handleVersioningStateLookupUpdate(n)}await this.getVersionInfos(r.url)}}}async _getVersioningStates(){return this.versioningStates&&this.versioningStates.length?this.versioningStates:this.view?await nt(this.view,!1):(this._logError("version-management-view-model:load-error","no-view-property"),new k)}_handleVersioningStateLookupUpdate(t){var e;this.versioningStateLookup.set(t.featureServiceUrl,t),this._addHandlesToVersioningState(t),this.versionIdentifierLookup.set(t.featureServiceUrl,(e=t.currentVersionInfo)==null?void 0:e.versionIdentifier),this.versionManagementServiceLookup.set(t.featureServiceUrl,t.versionManagementService)}async _setVersioningStatesLookups(){this._updatingHandlesLoad.addPromise((async()=>{this.versioningStates&&(this.removeHandles("versioning-states-change-handle"),this._updateFeatureServiceLookup(this.versioningStates),this.versioningStates.forEach(t=>this._handleVersioningStateLookupUpdate(t)),await this._updateVersioningStates(this.versioningStates))})())}_addHandlesToVersioningState(t){this.addHandles([x(()=>t.versionInfos,()=>{this.versionInfoLookup.set(t.featureServiceUrl,t.versionInfos)}),x(()=>{var e;return(e=t.currentVersionInfo)==null?void 0:e.versionIdentifier},()=>{var e;this.versionIdentifierLookup.set(t.featureServiceUrl,(e=t.currentVersionInfo)==null?void 0:e.versionIdentifier)})],"versioning-states-change-handle")}_resetVersioningLookupProperties(){this.versionIdentifierLookup=new Map,this.versionInfoLookup=new Map,this.versionManagementServiceLookup=new Map,this.versioningStateLookup=new Map}_resetAllLookupProperties(){this._portalLookup=new Map,this.advancedEditingUserTypeExtensionLookup=new Map,this.serverVersionLookup=new Map,this.userLookup=new Map,this.versioningStates=new k,this._resetVersioningLookupProperties(),this._resetServiceRelatedLookupProperties()}_resetServiceRelatedLookupProperties(){this.featureServiceLookup=new Map,this.serviceNameLookup=new Map}_setExecutionError(t){this._set("executionError",t)}_setLoadError(t){this._set("loadError",t)}};a([l()],m.prototype,"_portalLookup",void 0),a([l()],m.prototype,"advancedEditingUserTypeExtensionLookup",void 0),a([l({readOnly:!0})],m.prototype,"executionError",void 0),a([l()],m.prototype,"featureServiceLookup",void 0),a([l({readOnly:!0})],m.prototype,"loadError",void 0),a([l()],m.prototype,"serverVersionLookup",void 0),a([l()],m.prototype,"serviceNameLookup",void 0),a([l({readOnly:!0})],m.prototype,"state",null),a([l()],m.prototype,"userLookup",void 0),a([l()],m.prototype,"versionIdentifierLookup",void 0),a([l()],m.prototype,"versionInfoLookup",void 0),a([l()],m.prototype,"versionManagementServiceLookup",void 0),a([l()],m.prototype,"versioningStateLookup",void 0),a([l()],m.prototype,"view",void 0),a([l()],m.prototype,"versioningStates",void 0),m=a([N("esri.widgets.VersionManagement.VersionManagementViewModel")],m);const Et=m;export{Et as default};
