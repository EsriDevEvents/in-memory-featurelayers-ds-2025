import{i as k}from"./CIMResourceManager-mkE9OYNU.js";import{e as _,a as E,K as F}from"./CIMSymbolHelper-DBCkPMeB.js";import{ik as P,il as G}from"./index-Dv-JqQDv.js";import"./fontUtils-CnE29zYd.js";import"./imageUtils-CyYQ2a5H.js";import"./BidiEngine-BwB1Df7c.js";import"./GeometryUtils-CGcKgdcH.js";import"./enums-BRXbslMp.js";import"./definitions-ByNBSgP9.js";import"./mat2d-C6u6dH6d.js";import"./mat2df32-orApM5a3.js";import"./vec2-DGogPjh1.js";import"./vec2f32-BbH2jxlN.js";import"./Rect-CUzevAry.js";import"./BoundingBox-BhuXqU4L.js";const q=96/72;class X{constructor(g){this._spatialReference=g,this._imageDataCanvas=null,this._cimResourceManager=new k}get _canvas(){return this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas")),this._imageDataCanvas}get resourceManager(){return this._cimResourceManager}async rasterizeCIMSymbolAsync(g,d,w,f,s,i,n,o,M){if(!g)return null;const{data:c}=g;if(!c||c.type!=="CIMSymbolReference"||!c.symbol)return null;const{symbol:C}=c;i||(i=P(C));const a=await G.resolveSymbolOverrides(c,d,this._spatialReference,s,i,n,o),l=this._cimResourceManager,p=[];_.fetchResources(a,l,p),_.fetchFonts(a,l,p),p.length>0&&await Promise.all(p);const{width:t,height:r}=w,R=D(i,t,r,f),e=_.getEnvelope(a,R,l);if(!e)return null;let h=1,I=0,v=0;switch(C.type){case"CIMPointSymbol":case"CIMTextSymbol":{let m=1;e.width>t&&(m=t/e.width);let u=1;e.height>r&&(u=r/e.height),f==="preview"&&(e.width<t&&(m=t/e.width),e.height<r&&(u=r/e.height)),h=Math.min(m,u),I=e.x+e.width/2,v=e.y+e.height/2}break;case"CIMLineSymbol":{(M||e.height>r)&&(h=r/e.height),v=e.y+e.height/2;const m=e.x*h+t/2,u=(e.x+e.width)*h+t/2,{paths:b}=R;b[0][0][0]-=m/h,b[0][2][0]-=(u-t)/h}break;case"CIMPolygonSymbol":{I=e.x+e.width/2,v=e.y+e.height/2;const m=e.x*h+t/2,u=(e.x+e.width)*h+t/2,b=e.y*h+r/2,S=(e.y+e.height)*h+r/2,{rings:y}=R;m<0&&(y[0][0][0]-=m,y[0][3][0]-=m,y[0][4][0]-=m),b<0&&(y[0][0][1]+=b,y[0][1][1]+=b,y[0][4][1]+=b),u>t&&(y[0][1][0]-=u-t,y[0][2][0]-=u-t),S>r&&(y[0][2][1]+=S-r,y[0][3][1]+=S-r)}}const z={type:"cim",data:{type:"CIMSymbolReference",symbol:a}};return this.rasterize(z,t,r,I,v,h,i,1,R)}rasterize(g,d,w,f,s,i,n,o=0,M=null){const{data:c}=g;if(!c||c.type!=="CIMSymbolReference"||!c.symbol)return null;const{symbol:C}=c,a=this._canvas,l=(window.devicePixelRatio||1)*q;a.width=d*l,a.height=w*l,n||(n=P(C)),M||(M=D(n,d,w,"legend")),a.width+=2*o,a.height+=2*o;const p=a.getContext("2d",{willReadFrequently:!0}),t=F.createIdentity();return t.translate(-f,-s),t.scale(i*l,-i*l),t.translate(d*l/2+o,w*l/2+o),p.clearRect(0,0,a.width,a.height),new E(p,this._cimResourceManager,t,!0).drawSymbol(C,M),p.getImageData(0,0,a.width,a.height)}}function D(x,g,d,w){const s=-g/2+1,i=g/2-1,n=d/2-1,o=-d/2+1;switch(x){case"esriGeometryPoint":return{x:0,y:0};case"esriGeometryPolyline":return{paths:[[[s,0],[0,0],[i,0]]]};default:return w==="legend"?{rings:[[[s,n],[i,0],[i,o],[s,o],[s,n]]]}:{rings:[[[s,n],[i,n],[i,o],[s,o],[s,n]]]}}}export{X as CIMSymbolRasterizer};
