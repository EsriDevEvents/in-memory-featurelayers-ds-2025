import{a6 as Fe,s as Q,o as ge,gH as He,hM as be,cw as Ve,ae as Le,cc as je,o3 as De,o4 as Be,ad as Y,p as ke,dz as Ge,c4 as Ne,dQ as $e,G as ye,j as S,y as j,P as ze}from"./index-Dv-JqQDv.js";import{n as We,s as qe}from"./mat3-B7LiNcRs.js";import{e as _e,o as K}from"./mat3f64-BBpwCtoL.js";import{e as we}from"./mat4f64-Dk4dwAN8.js";import{t as Je}from"./quatf64-BrpT0VRp.js";import{u as Xe}from"./computeTranslationToOriginAndRotation-DBznw1xD.js";import{x as Qe,f as Ye,t as Ke,i as Ze}from"./Transform-C34taZRO.js";import{n as et}from"./projectVectorToVector-BbXjU1Ty.js";import{c as tt,x as it,L as rt,i as Z,O as ot,E as st,u as at,k as nt,B as ve,g as xe}from"./BufferView-_0HdWB6j.js";import{r as E,a as ee,S as D,N as U,e as u,m as lt,d as mt,g as Ce,t as P,n as te,i as R}from"./ILyr3DWasmPerSceneView-vPx4somd.js";import{R as Te}from"./elevationInfoUtils-Cey9W7Lb.js";import{l as ct}from"./ViewingMode-Dodu7ZZk.js";import{t as pt}from"./WaterSurface.glsl-BZtDPgAH.js";import{d as dt}from"./RenderGeometry-D3-u-2b6.js";import{l as ht}from"./LayerView3D-CIKXmWRc.js";import{i as ut,l as B,a as Me}from"./DefaultUI-BWAdHYa0.js";import{s as $,e as A,u as Pe}from"./basicInterfaces-wONHx_SN.js";import{E as Ee,D as x}from"./enums-BlUEVwJR.js";import{l as ft}from"./ElevationQueryTileCache-BJ_8u3U9.js";import{i as gt,e as bt,G as yt}from"./ElevationProvider-DZcTQ1wD.js";import{m as _t,A as wt}from"./OutputHighlight.glsl-Bs_35Qno.js";import{e as vt}from"./ElevationRange-BrgM1moX.js";import{I as xt,J as Ct,t as k}from"./orientedBoundingBox-BiAE_4Zn.js";import{b as Tt,I as Mt,d as Pt}from"./Viewshed.glsl-Dgwz8otk.js";import{s as Et}from"./RenderTexture-B_EQhGnV.js";import{d as Oe,N as Ot}from"./DefaultTechniqueConfiguration-C28-5KBi.js";import{c as Ut}from"./Normals-bmFJkGdK.js";import{e as G}from"./VertexAttribute-BnAa5VW0.js";import{y as At}from"./LayerView-6INZgiuX.js";import{c as It}from"./layerViewUtils-D2JqIDZ8.js";import"./sphere-j1PWtIhy.js";import"./plane-4BN6ZBDV.js";import"./vec2f64-Diu2Kaa8.js";import"./mathUtils-urfecwwD.js";import"./projectPointToVector-ARkh6gdu.js";import"./vec2-DGogPjh1.js";import"./ColorMaterial.glsl-D5JrE5f2.js";import"./debugFlags-CfrzpJ7g.js";import"./interfaces-B8ge7Jg9.js";import"./InterleavedLayout-B5L5JJLV.js";import"./types-D0PSWh4d.js";import"./Util-CQaYQWOS.js";import"./Matrix4PassUniform-B-NXMru_.js";import"./BindType-BmZEZMMh.js";import"./renderState-yUi34s5A.js";import"./ShaderTechniqueConfiguration-D3UbJ2mX.js";import"./hydratedFeatures-D9SfIMrp.js";import"./floatRGBA-BTfDfCN4.js";import"./Texture-BsiXXqc8.js";import"./vec2f32-BbH2jxlN.js";import"./dehydratedFeatures-OxpG9XrG.js";import"./edgeUtils-BJ2b_x7k.js";import"./DecodeSymbolColor.glsl-C6Fgb1JQ.js";import"./Float4DrawUniform-DDO6IFxX.js";import"./earcut-BqgeR2O3.js";import"./_commonjsHelpers-DCkdB7M8.js";import"./DoubleArray-DzYWDmvK.js";import"./Indices-BTetzIKW.js";import"./vec3-zd-aCjeY.js";import"./SnappingCandidate-O5eRSE6e.js";import"./triangulationUtils-BhDjnI5P.js";import"./deduplicate-DQWVMiBh.js";import"./triangle-0a93pGd5.js";import"./lineSegment-C_r0Slta.js";import"./RealisticTree.glsl-Cu8STgaR.js";import"./devEnvironmentUtils-D6qIi8Ky.js";import"./vec4-mLjVaC0N.js";import"./DefaultMaterial_COLOR_GAMMA-32Y4lnr4.js";import"./quat-B52zwwOM.js";import"./resourceUtils-Bb92V0U7.js";import"./NestedMap-DgiGbX8E.js";import"./requestImageUtils-CO_Ks2k6.js";import"./verticalOffsetUtils-DVynISE7.js";import"./CIMSymbolHelper-DBCkPMeB.js";import"./BidiEngine-BwB1Df7c.js";import"./fontUtils-CnE29zYd.js";import"./GeometryUtils-CGcKgdcH.js";import"./enums-BRXbslMp.js";import"./definitions-ByNBSgP9.js";import"./mat2d-C6u6dH6d.js";import"./mat2df32-orApM5a3.js";import"./Rect-CUzevAry.js";import"./BoundingBox-BhuXqU4L.js";import"./lineStippleUtils-BesjtKyl.js";import"./projectVectorToPoint-D_lHmELE.js";import"./MeshComponent-CKdOnzQW.js";import"./imageUtils-CyYQ2a5H.js";import"./MeshVertexAttributes-CERcIROX.js";import"./meshVertexSpaceUtils-1Rv9Wig9.js";import"./MeshLocalVertexSpace-Bf4xmfpu.js";import"./projection-CsHR6jE_.js";import"./spatialReferenceEllipsoidUtils-MFgRhPLs.js";import"./DefaultLayouts-CvcU3NmP.js";import"./frustum-W7EQ25hI.js";import"./webStyleSymbolUtils-DSxq9N1_.js";import"./glUtil-C6KhMg1m.js";import"./VertexElementDescriptor-BOD-G50G.js";import"./Octree-BaSixQu1.js";import"./BufferObject-Dhco7AlX.js";import"./Intersector-TO0eVp6c.js";import"./Scheduler-KZBBWfDI.js";import"./signal-0tlktF45.js";import"./debugFlags-CVnXAL57.js";import"./weather-K8rA5AE9.js";import"./vec3f32-Cw9Q6TO_.js";import"./axisAngleDegrees-CRhw0Lf9.js";import"./Intersector-BLO31d1u.js";import"./VertexArrayObject-Czm05pt7.js";import"./heightModelInfoUtils-DQiO1_HQ.js";import"./jsxFactory-C3RLkrq9.js";import"./UpdatingHandles-C0Kh7aEt.js";import"./InputManager-BwD1PEf3.js";import"./Map-DV4_DU8O.js";import"./Ground-DpNOewuO.js";import"./CollectionFlattener-73Uag1LF.js";import"./editableLayers-V9yr_aA-.js";import"./catalogUtils-CiWgGrdS.js";import"./TablesMixin-BFT6ikAR.js";import"./GraphicsCollection-DlcRCtU0.js";import"./ReactiveMap-DxvIcNmk.js";import"./selectionUtils-DYi6daQO.js";import"./IViewEvents-Bci6PjlS.js";import"./interfaces-D6pIddIh.js";import"./screenUtils-DKZWDFXK.js";import"./a11yUtils-DW8v-NB5.js";import"./capabilities-C84AMSCg.js";import"./themeUtils-C3zvZbsE.js";import"./globalCss-CZa70j6i.js";import"./accessibleHandler-CEs_6QlQ.js";import"./Compass-DBSyeZOs.js";import"./utils-DsJqvptN.js";import"./GoTo-BCG1WN4R.js";import"./NavigationToggle-CRz1xlJz.js";import"./Zoom-C6srvgaZ.js";import"./LayerConstants-B33OP6sh.js";import"./boundedPlane-DBcMJiAN.js";import"./Viewpoint-kowK2Ox4.js";import"./Cyclical-L5YKfO29.js";import"./RenderCoordsHelper-DKS3Y6VB.js";import"./viewpointUtils-Bk1t9hXb.js";import"./earthUtils-D6ZAndqJ.js";import"./spatialReferenceSupport-hDa_4tCr.js";import"./ElevationSamplerData-CTsi29Ag.js";import"./terrainUtils-BNct5mku.js";import"./TileInfo-Dsgw3bLM.js";import"./TileKey-DZd6gJy7.js";import"./Environment-Jr1y7jce.js";import"./quantityUtils-CvTt11a2.js";import"./Program-By3cM00b.js";import"./ShadowCastVisualizeTechniqueConfiguration-MkEH-Ojf.js";import"./euclideanLengthMeasurementUtils-DU6F1DKF.js";import"./ray-DhyD5gIv.js";import"./ZoomMomentumEstimator-BsIgzjw7.js";import"./labelFormatUtils-Dqk4IbyQ.js";import"./FeatureTileDescriptor3D-7bhVDC-s.js";import"./geometryServiceUtils-Bg30a3zi.js";import"./project-DnDtHu17.js";import"./hitTestSelectUtils-UXJPjatw.js";import"./ByteSizeUnit-BsxeN7wM.js";import"./RenderableTile-D8pMnDSe.js";import"./enums-BRzLM11V.js";import"./TileStrategy-Bm9AEGL5.js";import"./TileKey-DixmkgbB.js";import"./QueueProcessor-DHxW4yaI.js";import"./config-MDUrh2eL.js";import"./DefaultVertexAttributeLayouts-BaFfZuup.js";import"./DisplayObject-NwP1D55U.js";import"./StyleDefinition-BK3ROBTO.js";import"./resources-DCd8hSXv.js";import"./edgeProcessing-AsuFhimy.js";import"./testSVGPremultipliedAlpha-D_Za_c1C.js";import"./RenderingContext-4XQ9xHRL.js";import"./ProgramCache-DtSlkqy0.js";import"./doublePrecisionUtils-B0owpBza.js";class St extends pt{constructor(e,c,s,m,n,o,p){super(e,0,0,0,c),this.nodesCached=s,this.vboMB=m,this.textureMB=n,this.vboMBCached=o,this.textureMBCached=p}}const Rt={[E.Points]:null,[E.Lines]:null,[E.LineStrip]:null,[E.Triangles]:Ee.TRIANGLES,[E.TriangleStrip]:Ee.TRIANGLE_STRIP,[E.NotSet]:null},Ue={[ee.Opaque]:$.Opaque,[ee.Mask]:$.Mask,[ee.Blend]:$.Blend},Ft={[D.Back]:A.Back,[D.Front]:A.Front,[D.None]:A.None,[D.NotSet]:A.Back},Ht={[U.WrapYBit]:{s:x.CLAMP_TO_EDGE,t:x.REPEAT},[U.WrapXBit]:{s:x.REPEAT,t:x.CLAMP_TO_EDGE},[U.WrapXy]:{s:x.REPEAT,t:x.REPEAT},[U.None]:{s:x.CLAMP_TO_EDGE,t:x.CLAMP_TO_EDGE},[U.NotSet]:{s:x.CLAMP_TO_EDGE,t:x.CLAMP_TO_EDGE}},Vt={[u.U8]:1,[u.I8]:1,[u.U16]:2,[u.I16]:2,[u.U32]:4,[u.I32]:4,[u.F32]:4,[u.F64]:8,[u.Utf8String]:1,[u.NotSet]:1};class Lt{constructor(e){this.layerUid=[],this.type=gt.TILES3D,this.slicePlaneEnabled=!1,this.isGround=!0,this.layerView=e,this.layerUid.push(e.layer.uid)}intersect(e,c,s,m,n,o){const p=e.results,_=e.options.store===bt.ALL;if(e.options.filteredLayerUids.includes(this.layerView.layer.uid))return;const w=this.layerView.view._stage.renderView.componentObjectCollection,f=new _t(o??!1,e.options.normalRequired);this.layerView.objects.forEach(h=>{h.visible&&h.intersectionGeometry&&w.intersect(h,s,m,e.tolerance,null,f,(d,a,i,g)=>{if(a>=0){if(c!=null&&!c(s,m,a))return;const l=T=>{const C=new ft(this.layerView.layer.uid,()=>this._createTiles3DGraphic(this.layerView.layer,{}));T.set(this.type,C,a,i)};if(this.isGround&&(p.ground.dist==null||a<p.ground.dist)&&l(p.ground),e.options.isFiltered)return;if((p.min.dist==null||a<p.min.dist)&&l(p.min),(p.max.dist==null||a>p.max.dist)&&l(p.max),_){const T=yt(e.ray);l(T),e.results.all.push(T)}}})})}_createTiles3DGraphic(e,c){return new Fe({layer:e,sourceLayer:e,attributes:c})}}var b;(function(t){t[t.API=1]="API",t[t.VerboseAPI=2]="VerboseAPI",t[t.Error=3]="Error"})(b||(b={}));class jt{constructor(){this.handle=0,this.isVisible=!1,this.components=[],this.texMemoryUsage=0,this.vboMemoryUsage=0,this.cpuMemoryUsage=0,this.textures=[]}totalMemory(){return this.texMemoryUsage+this.vboMemoryUsage+this.cpuMemoryUsage}}function N(t){return Math.round(t/1048.576)/1e3}let O=class extends ht(At){constructor(){super(...arguments),this.type="integrated-mesh-3dtiles",this._visibleGeometryChangedSchedulerHandle=null,this._wasmLayerId=-1,this.ignoresMemoryFactor=!1,this.drapeTargetType=dt.WithoutRasterImage,this._lyrHandleToObjects=new Map,this._initialCullFace=new Map,this._suspendedHandle=null,this._dbgFlags=new Set}initialize(){if(this._dbgFlags.add(b.Error),this._dbg(b.VerboseAPI,"Tiles3DLayerView3D initialize() called"),!this._canProjectWithoutEngine())throw new Q("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});const t=ut(this).then(e=>{this._intersectionHandler=new Lt(this),this.view.sceneIntersectionHelper.addIntersectionHandler(this._intersectionHandler),this._updatingHandles.add(()=>this.slicePlaneEnabled,s=>this._slicePlaneEnabledChange(s)),this._elevationProvider=new Qe({view:this.view,layerElevationSource:this,intersectionHandler:this._intersectionHandler}),this.view.elevationProvider.register("im",this._elevationProvider),this.view.basemapTerrain.overlayManager.registerDrapeTarget(this),this._wasmLayerId=e;const c=this.view.resourceController.memoryController.newCache(`t3d-${this.uid}`,s=>this._onRemoveFromCache(s));this._memCache=c,this.addHandles([ge(()=>this.layer.elevationInfo,s=>this._elevationInfoChanged(s))]),this._suspendedHandle=ge(()=>this.suspended,s=>{const m=B(this.view);m&&m.setEnabled(this,!s)},He)}).catch(e=>{if(Me(this),this._wasmLayerId=-1,e===lt)throw new Q("tiles3d:addLayer-failure","The 3d tiles layer description was invalid.",{});if(e===mt)throw new Q("tiles3d:addLayer-failure","The 3d tiles layer web assembly module failed to download.",{})});this.addResolvingPromise(t)}destroy(){this._dbg(b.VerboseAPI,"Tiles3DLayerView3D destroy() called"),Me(this),this._suspendedHandle&&(this._suspendedHandle.remove(),this._suspendedHandle=null),this._intersectionHandler&&(this.view.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler),this._intersectionHandler=null),this._elevationProvider&&(this._elevationProvider.objectsChanged(this._obbs),this.view.elevationProvider.unregister(this._elevationProvider),this._elevationProvider=null),this.view.basemapTerrain.overlayManager.unregisterDrapeTarget(this),this._lyrHandleToObjects.forEach(t=>this.freeObject(t)),this._lyrHandleToObjects.clear(),this._initialCullFace.clear(),this._memCache=be(this._memCache),this._updatingHandles=be(this._updatingHandles),this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=null)}_visibleGeometryChanged(){this._visibleGeometryChangedSchedulerHandle==null&&(this._visibleGeometryChangedSchedulerHandle=Ve(()=>{this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle=null}))}_slicePlaneEnabledChange(t){this._intersectionHandler&&(this._intersectionHandler.slicePlaneEnabled=t),this.objects.forEach(e=>{const c=this._collection.getMaterial(e);c.commonMaterialParameters.hasSlicePlane=t,c.commonMaterialParameters.cullFace=t?A.None:this._initialCullFace.get(e)})}_elevationInfoChanged(t){const e=B(this.view);e&&e.setLayerOffset(this,Te(t))}get _obbs(){return this.objects.map(t=>this._collection.getComponentObb(t))}get wasmLayerId(){return this._wasmLayerId}get usedMemory(){let t=0;return this._lyrHandleToObjects.forEach(e=>{e.isVisible&&(t+=e.totalMemory())}),t}get unloadedMemory(){let t=0;return this._lyrHandleToObjects.forEach(e=>{e.isVisible||(t+=e.totalMemory())}),t}get visibleAtCurrentScale(){return It(this.layer.effectiveScaleRange,this.view.terrainScale)}get performanceInfo(){let t=0,e=0,c=0,s=0,m=0,n=0;return this._lyrHandleToObjects.forEach(o=>{o.isVisible?(t+=o.texMemoryUsage,e+=o.vboMemoryUsage,m++):(c+=o.texMemoryUsage,s+=o.vboMemoryUsage,n++)}),new St(this.usedMemory,m,n,N(e),N(t),N(s),N(c))}_canProjectWithoutEngine(){var t,e;if(this.view.state.viewingMode===ct.Local){const c=(t=this.view.renderSpatialReference)!=null&&t.isWebMercator?3857:((e=this.view.renderSpatialReference)==null?void 0:e.wkid)??-1;if(c!==3857&&c!==32662)return!1}return!0}get _stage(){return this.view._stage}get _collection(){return this._stage.renderView.componentObjectCollection}get elevationOffset(){return Te(this.layer.elevationInfo)}get elevationRange(){const t=this.fullExtent;return t!=null&&t.zmin&&(t!=null&&t.zmax)?new vt(t.zmin,t.zmax):null}getElevationRange(t){return null}get fullExtent(){return this.layer.fullExtent}get objects(){return Array.from(this._lyrHandleToObjects.values()).reduce((t,e)=>t.concat(e.components),new Array)}isUpdating(){const t=B(this.view);return!(this._wasmLayerId<0||t==null)&&t.isUpdating(this._wasmLayerId)}updatingFlagChanged(){this.notifyChange("updating")}async createRenderable(t){var a;const e=t.meshData;if(e.data==null)throw new Error("meshData.data undefined");if(e.desc=JSON.parse(e.desc),e.desc==null)throw new Error("meshData.desc undefined");const c=Le(e.desc.origin),s=new Array,m=new Map,n=new jt;n.handle=t.handle,this._lyrHandleToObjects.set(t.handle,n);const o=this.view.basemapTerrain.spatialReference;let p,_;if(this.view.viewingMode==="global"){const i=we();Xe(je,c,i,o),p=We(_e(),i),_=qe(_e(),p)}else p=K,_=K;const w=we();De(w,w,c);const f=Be(Y(),w);let h=null;const d=Y();if(e.desc.obb){const i=e.desc.obb.quaternion;h=new xt(e.desc.obb.center,e.desc.obb.halfSize,Je(i[0],i[1],i[2],i[3]))}for(let i=0;i<e.desc.prims.length;i++){const g=e.desc.prims[i];if(this._dbg(b.VerboseAPI,JSON.stringify(g)),g.ptype===E.Lines)continue;if(Rt[g.ptype]==null||e.data==null){this._dbg(b.VerboseAPI,"[Unsupported Feature] Unsupported primitive mode ("+g.ptype+"). Skipping primitive.");continue}const l=(a=e.desc)!=null&&a.materials&&g.materialId!=null?e.desc.materials[g.materialId]:null,T=l!=null?l.lightingModel:Ce.Unlit,C=!ke("disable-feature:im-shading"),{positionView:y,positionAttr:M,normalsView:Ae,normalsAttr:z,colorAttr:F,texCoord0Attr:H,indicesView:I}=this.getBufferViews(g,e.data.buffer,p,C);if(M==null||y==null||I==null)continue;const ie={colors:F!=null,textureCoordinates:H!=null?Oe.Default:Oe.None,hasNormals:Ae!=null,needsNormals:C},Ie=M.data.length/M.size,W=(r,v)=>!r||r.data.length/r.size===Ie||(this._dbg(b.Error,`${v} !== numPos. Skipping primitive.`),!1);if(!W(H,"numTexcoord")||!W(F,"numColors")||!W(z,"normals"))continue;const re=Tt(ie);if(h!=null?h=h.clone():(h=Ct(M),Ge(d,h.center,c),h.center=d),p!==K)for(let r=0;r<y.count;r++)y.getVec(r,d),Ne(d,d,p),y.setVec(r,d);const q=re.createBuffer(M.data.length),V=new Map([[G.POSITION,M]]);H!=null&&V.set(G.UV0,H),F!=null&&V.set(G.COLOR,F),z!=null&&V.set(G.NORMALCOMPRESSED,z),V.forEach((r,v)=>{r!=null&&wt(v,r,null,null,q,0)});const Se=new Uint32Array([0,I.typedBuffer.length]),Re={vertices:{data:q.buffer,count:q.byteLength/re.stride,layoutParameters:ie},positionData:{positions:y.typedBuffer,indices:I.typedBuffer},indices:I.typedBuffer,componentOffsets:Se};n.cpuMemoryUsage+=y.count,n.cpuMemoryUsage+=I.count;const oe=this.view.renderSpatialReference,J=Y(),X=[1,1,1];Ye(f,oe,X,o)||this._dbg(b.Error,"Unsupported coordinate system for IM overlay"),et(f,oe,J,o);const L=this._collection.createObject(new Ke($e(J[0],J[1],X[0],X[1]),new Ze(f,_),h,Re));l&&this._collection.updateMaterial(L,r=>{r.baseColor=l.baseColorFactor,r.usePBR=T===Ce.Pbr,r.hasParametersFromSource=!1,r.baseColorTexture=this._getTexture(l.baseColorTex,e,m),r.usePBR&&(r.mrrFactors=[l.metallicFactor,l.roughnessFactor,0],r.emissiveFactor=l.emissiveFactor??[0,0,0],r.metallicRoughnessTexture=this._getTexture(l.metalTex,e,m),r.emissionTexture=this._getTexture(l.emissiveTex,e,m),r.occlusionTexture=this._getTexture(l.occlusionTex,e,m),r.normalTexture=this._getTexture(l.normalTex,e,m)),r.objectOpacity=0,r.alphaDiscardMode=$.Mask;const v=[];r.baseColorTexture&&v.push(r.baseColorTexture.loadPromise),r.usePBR&&r.metallicRoughnessTexture&&v.push(r.metallicRoughnessTexture.loadPromise),r.usePBR&&r.emissionTexture&&v.push(r.emissionTexture.loadPromise),r.usePBR&&r.occlusionTexture&&v.push(r.occlusionTexture.loadPromise),r.usePBR&&r.normalTexture&&v.push(r.normalTexture.loadPromise);const se=Promise.all(v);s.push(se),se.then(()=>{var ae,ne,le,me,ce,pe,de,he,ue,fe;r.alphaDiscardMode=Ue[l.alphaMode],r.objectOpacity=1,n.texMemoryUsage+=((ne=(ae=r.baseColorTexture)==null?void 0:ae.glTexture)==null?void 0:ne.usedMemory)||0,r.usePBR&&(n.texMemoryUsage+=((me=(le=r.metallicRoughnessTexture)==null?void 0:le.glTexture)==null?void 0:me.usedMemory)||0,n.texMemoryUsage+=((pe=(ce=r.emissionTexture)==null?void 0:ce.glTexture)==null?void 0:pe.usedMemory)||0,n.texMemoryUsage+=((he=(de=r.occlusionTexture)==null?void 0:de.glTexture)==null?void 0:he.usedMemory)||0,n.texMemoryUsage+=((fe=(ue=r.normalTexture)==null?void 0:ue.glTexture)==null?void 0:fe.usedMemory)||0)}),r.commonMaterialParameters.doubleSided=l.isDoubleSided,r.commonMaterialParameters.cullFace=l.faceCulling?Ft[l.faceCulling]:A.Back,this._initialCullFace.set(L,r.commonMaterialParameters.cullFace),r.commonMaterialParameters.hasSlicePlane=this.slicePlaneEnabled,r.componentParameters.castShadows=Mt.All,r.textureAlphaCutoff=l.alphaCutoff??.1,r.alphaDiscardMode=Ue[l.alphaMode],r.isIntegratedMesh=!0,r.polygonOffsetEnabled=!1,r.hasOccludees=!1,r.ellipsoidMode=Pt(this.view.spatialReference)}),n.components.push(L),n.vboMemoryUsage+=this._collection.getObjectGPUMemoryUsage(L)}if(await Promise.all(s),m.forEach(i=>{n.textures.push(i)}),!this._memCache)throw new Error("no memCache");return this._memCache.put(`${n.handle}`,n,n.totalMemory()),{memUsageBytes:n.totalMemory()}}freeRenderable(t){const e=this._lyrHandleToObjects.get(t);e&&(this.freeObject(e),this._lyrHandleToObjects.delete(t))}freeObject(t){this._memCache&&this._memCache.pop(`${t.handle}`),t.components.forEach(e=>{t.textures.forEach(c=>{this._stage.remove(c)}),this._collection.destroyObject(e),this._initialCullFace.delete(e)})}setRenderableVisibility(t,e,c){if(this._memCache){for(let s=0;s<c;++s){const m=t[s],n=e[s];if(!n)continue;const o=this._lyrHandleToObjects.get(m);o&&(this._visibleGeometryChanged(),o.isVisible=n,o.components.forEach(p=>{this._collection.setObjectVisibility(p,n),this._elevationProvider.objectChanged(this._collection.getComponentObb(p))}),this._memCache.pop(`${m}`))}for(let s=0;s<c;++s){const m=t[s],n=e[s];if(n)continue;const o=this._lyrHandleToObjects.get(m);o&&(this._visibleGeometryChanged(),o.isVisible=n,o.components.forEach(p=>{this._collection.setObjectVisibility(p,n),this._elevationProvider.objectChanged(this._collection.getComponentObb(p))}),this._memCache.put(`${m}`,o,o.totalMemory()))}}}_getTexture(t,e,c){var m,n;let s=null;if(t&&((m=e.desc)!=null&&m.images)&&((n=e.data)!=null&&n.buffer)){const o=e.desc.images[t==null?void 0:t.imageId];if(s=c.get(o),!s&&o){const p=this._stage.renderView.renderingContext.parameters.maxMaxAnisotropy,_=p>1,w=Ht[t.wrapMode??U.None];let f=o.alpha?4:3;const h=new Uint8Array(e.data.buffer,o.data.byteOffset,o.data.byteCount);let d=null,a=null,i=null;switch(o.format){case P.Raw:o.pixelFormat===te.R8?(d=h.buffer,f=1,a=""):o.pixelFormat===te.Rgb8?(d=h.buffer,f=3,a=""):o.pixelFormat===te.Rgba8&&(d=h.buffer,f=4,a="");break;case P.Dxt1:d=h.buffer,f=3,a=Pe.DDS_ENCODING;break;case P.Dxt5:d=h.buffer,f=4,a=Pe.DDS_ENCODING;break;case P.Png:a="image/png",i=document.createElement("img");break;case P.Jpeg:a="image/jpeg",i=document.createElement("img");break;case P.Etc2:a="image/ktx",i=document.createElement("img");break;case P.Astc:this._dbg(b.Error,"Astc texture not supported");break;case P.Pvrtc:this._dbg(b.Error,"Pvrtc texture not supported")}if(i&&a){const g=new Blob([h],{type:a});i.src=URL.createObjectURL(g),d=i}d&&a!=null&&(s=new Ot(d,{mipmap:_,maxAnisotropy:p,encoding:a,wrap:w,components:f,noUnpackFlip:!0,width:o.mip0Width,height:o.mip0Height}),this._stage.add(s),c.set(o,s))}}return s?new Et(this.view._stage.renderView.textures,s.id):null}getBufferViews(t,e,c,s){let m,n,o,p,_,w,f,h=null;for(let d=0;d<t.atrbs.length;d++){const a=t.atrbs[d],i=a.view,g=void 0,l=i.byteOffset+i.byteCount,T=i.byteCount/Vt[i.type],C=[...Array(T).keys()].map(y=>y);try{switch(a.sem){case R.Position:i.ncomp!==3||i.type!==u.F32?this._dbg(b.Error,"[Unsupported Feature] Unsupported view for Position ("+i+")"):(m=new Z(e,i.byteOffset,g,l),n=new k(m.typedBuffer,C,3));break;case R.Normal:if(i.ncomp!==3||i.type!==u.F32)this._dbg(b.Error,"[Unsupported Feature] Unsupported view for Normal ("+i+")");else if(s){const y=new Z(e,i.byteOffset,g,l),M=Ut(y.typedBuffer,c);_=new nt(M),w=new k(_.typedBuffer,C,2)}break;case R.TexCoord:i.ncomp!==2||i.type!==u.F32?this._dbg(b.Error,"[Unsupported Feature] Unsupported view for Texcoord ("+i+")"):p===void 0&&(p=new k(new at(e,i.byteOffset,g,l).typedBuffer,C,2));break;case R.Color:i.ncomp===4?(i.type===u.F32&&(h=new tt(e,i.byteOffset,g,l)),i.type===u.U8&&(h=new it(e,i.byteOffset,g,l)),i.type===u.U16&&(h=new rt(e,i.byteOffset,g,l))):i.ncomp===3&&(i.type===u.F32&&(h=new Z(e,i.byteOffset,g,l)),i.type===u.U8&&(h=new ot(e,i.byteOffset,g,l)),i.type===u.U16&&(h=new st(e,i.byteOffset,g,l))),h==null?this._dbg(b.VerboseAPI,"[Unsupported Feature] Unsupported view for Color ("+i+")"):o=new k(h.typedBuffer,C,i.ncomp);break;case R.FeatureIndex:break;default:this._dbg(b.VerboseAPI,"[Unsupported Feature] Unsupported semantic ("+a.sem+"). Skipping vertex attribute.")}}catch(y){this._dbg(b.VerboseAPI,"Error Creating buffer ("+y+"). Skipping vertex attribute.")}}if(t.index){const d=t.index.view,a=void 0,i=d.byteOffset+d.byteCount;switch(t.index.view.type){case u.U16:f=new xe(e,d.byteOffset,a,i);break;case u.U32:f=new ve(e,d.byteOffset,a,i);break;case u.U8:default:this._dbg(b.Error,"[Unsupported Feature] index type not supported ("+d.type+").")}}if(f==null&&m!=null){const d=m.count;if(d<65535){const a=new Uint16Array(d);f=new xe(a)}else{const a=new Uint32Array(d);f=new ve(a)}for(let a=0;a<d;a++)f.set(a,a)}return{positionView:m,positionAttr:n,colorAttr:o,texCoord0Attr:p,indicesView:f,normalsView:_,normalsAttr:w}}_onRemoveFromCache(t){const e=B(this.view);e&&e.onRenderableEvicted(this,t.handle,t.totalMemory()),this.freeRenderable(t.handle)}_dbg(t,e){this._dbgFlags.has(t)&&(t===b.Error?ye.getLogger(this).error(e):ye.getLogger(this).warn(e))}};S([j()],O.prototype,"_visibleGeometryChangedSchedulerHandle",void 0),S([j()],O.prototype,"layer",void 0),S([j({readOnly:!0})],O.prototype,"visibleAtCurrentScale",null),S([j()],O.prototype,"elevationOffset",null),O=S([ze("esri.views.3d.layers.IntegratedMesh3DTilesLayerView3D")],O);const Ko=O;export{Ko as default};
