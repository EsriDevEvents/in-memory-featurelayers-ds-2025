import{b0 as b,gi as k,b3 as w,ao as D,gj as z,G,de as O,gk as S,gl as P,gm as E,gn as Q,go as F,b2 as I,gp as y}from"./index-Dv-JqQDv.js";const _="esri.widgets.Feature.support.featureUtils",h=()=>G.getLogger(_),H=/href=(""|'')/gi,B=/(\{([^{\r\n]+)\})/g,J=/'/g,j=/^\s*expression\//i,K=/(\n)/gi,V=/[\u00A0-\u9999<>&]/gim,W=/href\s*=\s*(?:"([^"]+)"|'([^']+)')/gi,X=/^(?:mailto:|tel:)/,v="relationships/",N=O("short-date-short-time");function Fe(e){if(e!=null)return(e.sourceLayer||e.layer)??void 0}async function Ne({type:e,value:n,event:t}){try{return typeof n=="function"?n(t):n}catch(r){return void h().error("error",`An error occurred when calling the "${e}" function`,{error:r,graphic:t.graphic,value:n})}}function Ze(e=""){if(e)return!X.test(e.trim().toLowerCase())}function Y(e){return!!e&&j.test(e)}function ee(e,n){if(!n||!Y(n)||!e)return;const t=n.replace(j,"").toLowerCase();return e.find(({name:r})=>r.toLowerCase()===t)}function $e(e,n){const t=ee(n,e==null?void 0:e.fieldName);return t?t.title||null:e?e.label||e.fieldName:null}function ne(e,n){const t=n.get(e.toLowerCase());return`{${(t==null?void 0:t.fieldName)||e}}`}function te(e){return e.replaceAll(H,"")}function x(e,n){const t=T(n,e);return t?t.name:e}function Le(e,n){return e&&e.map(t=>x(t,n))}function T(e,n){return e&&typeof e.getField=="function"&&n?e.getField(n)??null:null}function A(e){return`${e}`.trim()}function Ee({attributes:e,globalAttributes:n,layer:t,text:r,expressionAttributes:i,fieldInfoMap:a}){return r?re({formattedAttributes:n,template:ue(r,{...n,...i,...e},t),fieldInfoMap:a}):""}function re({formattedAttributes:e,template:n,fieldInfoMap:t}){return A(te(b(b(n,r=>ne(r,t)),e)))}function ie(e,n,t=!1){const r=n[e];if(typeof r=="string"){const i="%27",a=(t?encodeURIComponent(r):r).replaceAll(J,i);n[e]=a}}function ae(e,n=!1){const t={...e};return Object.keys(t).forEach(r=>ie(r,t,n)),t}function oe(e,n,t){const r=(n=A(n))&&n[0]!=="{";return b(e,ae(t,r||!1))}function le(e,n){return e.replaceAll(B,(t,r,i)=>{const a=T(n,i);return a?`{${a.name}}`:r})}function ue(e,n,t){const r=le(e,t);return r&&r.replaceAll(W,(i,a,o)=>oe(i,a||o,n))}function se(e,n){if(typeof e=="string"&&n&&n.dateFormat==null&&(n.places!=null||n.digitSeparator!=null)){const t=Number(e);if(!isNaN(t))return t}return e}function fe(e){return e!=null&&typeof e=="object"&&"fieldsIndex"in e&&"geometryType"in e&&"getField"in e&&"load"in e&&"loaded"in e&&"objectIdField"in e&&"spatialReference"in e&&"type"in e&&(e.type==="feature"||e.type==="scene"||e.type==="sublayer")&&"when"in e}function ce(e){return e!=null&&typeof e=="object"&&"createQuery"in e&&"queryFeatureCount"in e&&"queryObjectIds"in e&&"queryRelatedFeatures"in e&&"queryRelatedFeaturesCount"in e&&"relationships"in e}function C(e){return fe(e)&&ce(e)}function je(e){return!!e&&typeof e=="object"&&"sourceLayer"in e&&C(e.sourceLayer)}function de(e,n){var d;const{fieldInfos:t,fieldName:r,preventPlacesFormatting:i,layer:a,timeZone:o}=n,u=ye(t,r),l=T(a,r);if(u&&!F(r)){const f=l==null?void 0:l.type,c=(d=u.format)==null?void 0:d.dateFormat;if(f==="date"||f==="date-only"||f==="time-only"||f==="timestamp-offset"||c)return E(e,{format:c,fieldType:f,timeZoneOptions:{layerTimeZone:a&&"preferredTimeZone"in a?a.preferredTimeZone:null,viewTimeZone:o,datesInUnknownTimezone:!(!a||!("datesInUnknownTimezone"in a))&&!!a.datesInUnknownTimezone}})}const s=u==null?void 0:u.format;return typeof e=="string"&&F(r)&&s?pe(e,s):typeof(e=se(e,s))=="string"||e==null||s==null?q(e):I(e,i?{...y(s),minimumFractionDigits:0,maximumFractionDigits:20}:y(s))}function pe(e,n){return e=e.trim(),/\d{2}-\d{2}/.test(e)?e:e.includes(",")?g(e,",",", ",n):e.includes(";")?g(e,";","; ",n):e.includes(" ")?g(e," "," ",n):I(Number(e),y(n))}function g(e,n,t,r){return e.trim().split(n).map(i=>I(Number(i),y(r))).join(t)}function ye(e,n){if(e!=null&&e.length&&n)return e.find(t=>{var r;return((r=t.fieldName)==null?void 0:r.toLowerCase())===n.toLowerCase()})}function me({fieldName:e,graphic:n,layer:t}){if(R(e)||!t||typeof t.getFeatureType!="function")return null;const{typeIdField:r}=t;if(!r||e!==r)return null;const i=t.getFeatureType(n);return i?i.name:null}function ge({fieldName:e,value:n,graphic:t,layer:r}){if(R(e)||!r||typeof r.getFieldDomain!="function")return null;const i=t&&r.getFieldDomain(e,{feature:t});return i&&i.type==="coded-value"?i.getName(n):null}function ve(e,n,t,r){const{creatorField:i,creationDateField:a,editorField:o,editDateField:u}=e;if(!n)return;const l=k(r&&"preferredTimeZone"in r?r.preferredTimeZone:null,!(!r||!("datesInUnknownTimezone"in r))&&!!r.datesInUnknownTimezone,t,N,"date"),s={...N,...l},d=n[u];if(typeof d=="number"){const c=n[o];return{type:"edit",date:w(d,s),user:c}}const f=n[a];if(typeof f=="number"){const c=n[i];return{type:"create",date:w(f,s),user:c}}return null}function xe(e,n){const t=new Map;if(!e)return t;for(const r of e){if(!r.fieldName)continue;const i=x(r.fieldName,n);r.fieldName=i,t.set(i.toLowerCase(),r)}return t}function Ae(e){const n=[];if(!e)return n;const{fieldInfos:t,content:r}=e;return t&&n.push(...t),r&&Array.isArray(r)&&r.forEach(i=>{if(i.type==="fields"){const a=i==null?void 0:i.fieldInfos;a&&n.push(...a)}}),n}function Ce(e){return e.replaceAll(V,n=>`&#${n.charCodeAt(0)};`)}function q(e){return typeof e=="string"?e.replaceAll(K,'<br class="esri-text-new-line" />'):e}function M(e){var f;const{value:n,fieldName:t,fieldInfos:r,fieldInfoMap:i,layer:a,graphic:o,timeZone:u}=e;if(n==null)return"";const l=ge({fieldName:t,value:n,graphic:o,layer:a});if(l)return l;const s=me({fieldName:t,graphic:o,layer:a});if(s)return s;if(i.get(t.toLowerCase()))return de(n,{fieldInfos:r||Array.from(i.values()),fieldName:t,layer:a,timeZone:u});const d=(f=a==null?void 0:a.fieldsIndex)==null?void 0:f.get(t);return d&&(S(d)||P(d))?E(n,{fieldType:d.type,timeZoneOptions:{layerTimeZone:a&&"preferredTimeZone"in a?a.preferredTimeZone:null,viewTimeZone:u,datesInUnknownTimezone:!(!a||!("datesInUnknownTimezone"in a))&&!!a.datesInUnknownTimezone}}):q(n)}function qe({fieldInfos:e,attributes:n,layer:t,graphic:r,fieldInfoMap:i,relatedInfos:a,timeZone:o}){const u={};return a==null||a.forEach(l=>Te({attributes:u,relatedInfo:l,fieldInfoMap:i,fieldInfos:e,layer:t,timeZone:o})),n&&Object.keys(n).forEach(l=>{const s=n[l];u[l]=M({fieldName:l,fieldInfos:e,fieldInfoMap:i,layer:t,value:s,graphic:r,timeZone:o})}),u}async function be(e,n){var d,f;const{layer:t,graphic:r,outFields:i,objectIds:a,returnGeometry:o,spatialReference:u}=e,l=a[0];if(typeof l!="number"&&typeof l!="string"){const c="Could not query required fields for the specified feature. The feature's ID is invalid.",m={layer:t,graphic:r,objectId:l,requiredFields:i};return h().warn(c,m),null}if(!((f=(d=D(t))==null?void 0:d.operations)!=null&&f.supportsQuery)){const c="The specified layer cannot be queried. The following fields will not be available.",m={layer:t,graphic:r,requiredFields:i,returnGeometry:o};return h().warn(c,m),null}const s=t.createQuery();return s.objectIds=a,s.outFields=i!=null&&i.length?i:[t.objectIdField],s.returnGeometry=!!o,s.returnZ=!!o,s.returnM=!!o,s.outSpatialReference=u,(await t.queryFeatures(s,n)).features[0]}async function he(e){var r;if(!((r=e.expressionInfos)!=null&&r.length))return!1;const n=await Q(),{arcadeUtils:{hasGeometryFunctions:t}}=n;return t(e)}async function Me({graphic:e,popupTemplate:n,layer:t,spatialReference:r},i){if(!t||!n||(typeof t.load=="function"&&await t.load(i),!e.attributes))return;const a=t.objectIdField,o=e.attributes[a];if(o==null)return;const u=[o],l=await n.getRequiredFields(t.fieldsIndex),s=z(l,e),d=s?[]:l.includes(a)?l:[...l,a],f=n.returnGeometry||await he(n);if(s&&!f)return;const c=await be({layer:t,graphic:e,outFields:d,objectIds:u,returnGeometry:f,spatialReference:r},i);c&&(c.geometry&&(e.geometry=c.geometry),c.attributes&&(e.attributes={...e.attributes,...c.attributes}))}function R(e=""){return!!e&&e.includes(v)}function Ie(e){return e?`${v}${e.layerId}/${e.fieldName}`:""}function Z({attributes:e,graphic:n,relatedInfo:t,fieldInfos:r,fieldInfoMap:i,layer:a,timeZone:o}){e&&n&&t&&Object.keys(n.attributes).forEach(u=>{const l=Ie({layerId:t.relation.id.toString(),fieldName:u}),s=n.attributes[u];e[l]=M({fieldName:l,fieldInfos:r,fieldInfoMap:i,layer:a,value:s,graphic:n,timeZone:o})})}function Te({attributes:e,relatedInfo:n,fieldInfoMap:t,fieldInfos:r,layer:i,timeZone:a}){var o,u;e&&n&&((o=n.relatedFeatures)==null||o.forEach(l=>Z({attributes:e,graphic:l,relatedInfo:n,fieldInfoMap:t,fieldInfos:r,layer:i,timeZone:a})),(u=n.relatedStatsFeatures)==null||u.forEach(l=>Z({attributes:e,graphic:l,relatedInfo:n,fieldInfoMap:t,fieldInfos:r,layer:i,timeZone:a})))}const $=e=>{if(!e)return!1;const n=e.toUpperCase();return n.includes("CURRENT_TIMESTAMP")||n.includes("CURRENT_DATE")||n.includes("CURRENT_TIME")},U=({layer:e,method:n,query:t,definitionExpression:r})=>{var o,u;if(!((u=(o=e.capabilities)==null?void 0:o.query)!=null&&u.supportsCacheHint)||n==="attachments")return;const i=t.where!=null?t.where:null,a=t.geometry!=null?t.geometry:null;$(r)||$(i)||(a==null?void 0:a.type)==="extent"||t.resultType==="tile"||(t.cacheHint=!0)},Re=({query:e,layer:n,method:t})=>{U({layer:n,method:t,query:e,definitionExpression:`${n.definitionExpression} ${n.serviceDefinitionExpression??""}`})},Ue=({queryPayload:e,layer:n,method:t})=>{U({layer:n,method:t,query:e,definitionExpression:`${n.definitionExpression} ${n.serviceDefinitionExpression??""}`})};function ke(e,n,t){var r,i;return e&&n&&t?n.type==="sublayer"?p({layers:(r=n.layer)==null?void 0:r.sublayers,map:e,relatedLayer:n,relationship:t})||p({layers:(i=n.layer)==null?void 0:i.subtables,map:e,relatedLayer:n,relationship:t}):p({layers:e.allLayers,map:e,relatedLayer:n,relationship:t})||p({layers:e.allTables,map:e,relatedLayer:n,relationship:t}):null}function L(e,n){return e==null?void 0:e.allTables.find(t=>{var r;return t.type==="feature"&&t.layerId===n.id&&t.url===((r=n.layer)==null?void 0:r.url)})}function p({map:e,relationship:n,relationship:{relatedTableId:t},relatedLayer:r,layers:i}){var a;if(!i)return null;for(const o of i){if(o.type==="map-image"){const l=p({layers:o.sublayers,map:e,relatedLayer:r,relationship:n})||p({layers:o.subtables,map:e,relatedLayer:r,relationship:n});if(l)return l;continue}if(!C(o))continue;if(r.type==="sublayer"){if(o!==r&&o.id===t)return o.isTable?L(e,o):o;continue}const u=r.type==="scene"&&r.associatedLayer?r.associatedLayer.url:r.url;if(!u)return null;if(o.type!=="sublayer"){if(o!==r&&o.url===u&&o.layerId===t)return o}else if(o!==r&&((a=o.layer)==null?void 0:a.url)===u&&o.id===t)return o.isTable?L(e,o):o}return null}function De(e){const n=e.getObjectId();return n!=null?`oid:${n}`:`uid:${e.uid}`}export{$e as C,Ee as D,Ne as E,Ue as I,C as J,je as K,Fe as L,De as N,le as P,Le as R,ke as T,ye as Y,q as a,Re as b,Me as c,R as d,Ae as i,ve as n,Ce as o,x as q,xe as r,be as s,qe as u,Ze as v,Y as x,re as z};
