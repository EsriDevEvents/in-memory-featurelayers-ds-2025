import{ag as J,dC as P,ad as m,dz as C,cb as I,dA as w,dB as S,aN as T,c0 as X,aL as z,aQ as H,fK as x,aV as k}from"./index-Dv-JqQDv.js";import{e as W,o as j}from"./mat4f64-Dk4dwAN8.js";import{m as u,k as q,b as R}from"./sphere-j1PWtIhy.js";import{l as M}from"./ViewingMode-Dodu7ZZk.js";import{u as Q}from"./boundedPlane-DBcMJiAN.js";import{v as Y,d as B}from"./verticalOffsetUtils-DVynISE7.js";var l,O;(function(r){r[r.OBJECT=0]="OBJECT",r[r.HUD=1]="HUD",r[r.TERRAIN=2]="TERRAIN",r[r.OVERLAY=3]="OVERLAY",r[r.I3S=4]="I3S",r[r.PCL=5]="PCL",r[r.LOD=6]="LOD",r[r.VOXEL=7]="VOXEL",r[r.TILES3D=8]="TILES3D"})(l||(l={}));let F=class{constructor(){this.verticalOffset=0,this.selectionMode=!1,this.hud=!0,this.selectOpaqueTerrainOnly=!0,this.invisibleTerrain=!1,this.backfacesTerrain=!0,this.isFiltered=!1,this.filteredLayerUids=[],this.store=O.ALL,this.normalRequired=!0}};(function(r){r[r.MIN=0]="MIN",r[r.MINMAX=1]="MINMAX",r[r.ALL=2]="ALL"})(O||(O={}));let K=class{constructor(t,s,e){this.object=t,this.geometryId=s,this.triangleNr=e}},Z=class extends K{constructor(t,s,e,a){super(t,s,e),this.center=a!=null?J(a):null}};class tt{constructor(t){this.layerUid=t}}let yt=class extends tt{constructor(t,s){super(t),this.graphicUid=s}};function b(r){return(r==null?void 0:r.dist)!=null}function pt(r){return(t,s,e)=>(P(N,t,s,e),!Q(r,N))}function gt(r){return b(r)&&r.intersector===l.OBJECT&&!!r.target}function Ot(r){return b(r)&&r.intersector===l.HUD&&!!r.target&&"center"in r.target&&r.target.center!=null}const N=m(),D=1e-5;class rt{constructor(t){this.options=new F,this._results=new st,this.transform=new Y,this.tolerance=D,this.verticalOffset=null,this._ray=u(),this._rayEnd=m(),this._rayBeginTransformed=m(),this._rayEndTransformed=m(),this.viewingMode=t??M.Global}get results(){return this._results}get ray(){return this._ray}get rayBegin(){return this._ray.origin}get rayEnd(){return this._rayEnd}reset(t,s,e){this.resetWithRay(q(t,s,this._ray),e)}resetWithRay(t,s){this.camera=s,t!==this._ray&&R(t,this._ray),this.options.verticalOffset!==0?this.viewingMode===M.Local?this._ray.origin[2]-=this.options.verticalOffset:this.verticalOffset=this.options.verticalOffset:this.verticalOffset=null,C(this._rayEnd,this._ray.origin,this._ray.direction),this._results.init(this._ray)}intersect(t=null,s,e,a,o){var c;this.point=s,this.filterPredicate=a,this.tolerance=e??D;const f=B(this.verticalOffset);if(t&&t.length>0){const y=o?i=>{o(i)&&this.intersectObject(i)}:i=>{this.intersectObject(i)};for(const i of t){const d=(c=i.getSpatialQueryAccelerator)==null?void 0:c.call(i);d!=null?(f!=null?d.forEachAlongRayWithVerticalOffset(this._ray.origin,this._ray.direction,y,f):d.forEachAlongRay(this._ray.origin,this._ray.direction,y),this.options.selectionMode&&this.options.hud&&d.forEachDegenerateObject(y)):i.objects.forAll(L=>y(L))}}this.sortResults()}intersectObject(t){const s=t.geometries;if(!s)return;const e=t.effectiveTransformation,a=B(this.verticalOffset);for(const o of s){if(!o.visible)continue;const{material:f,id:c}=o;this.transform.setAndInvalidateLazyTransforms(e,o.transformation),I(this._rayBeginTransformed,this.rayBegin,this.transform.inverse),I(this._rayEndTransformed,this.rayEnd,this.transform.inverse);const y=this.transform.transform;a!=null&&(a.objectTransform=this.transform),f.intersect(o,this.transform.transform,this,this._rayBeginTransformed,this._rayEndTransformed,(i,d,L,v,_,G)=>{if(i>=0){if(this.filterPredicate!=null&&!this.filterPredicate(this._ray.origin,this._rayEnd,i))return;const n=v?this._results.hud:this._results,E=v?h=>{const V=new Z(t,c,L,G);h.set(l.HUD,V,i,d,j,_)}:h=>h.set(l.OBJECT,{object:t,geometryId:c,triangleNr:L},i,d,y,_);if((n.min.drapedLayerOrder==null||_>=n.min.drapedLayerOrder)&&(n.min.dist==null||i<n.min.dist)&&E(n.min),this.options.store!==O.MIN&&(n.max.drapedLayerOrder==null||_<n.max.drapedLayerOrder)&&(n.max.dist==null||i>n.max.dist)&&E(n.max),this.options.store===O.ALL)if(v){const h=new $(this._ray);E(h),this._results.hud.all.push(h)}else{const h=new p(this._ray);E(h),this._results.all.push(h)}}})}}sortResults(t=this._results.all){t.sort((s,e)=>s.dist!==e.dist?(s.dist??0)-(e.dist??0):s.drapedLayerOrder!==e.drapedLayerOrder?U(s.drapedLayerOrder,e.drapedLayerOrder):U(s.drapedLayerGraphicOrder,e.drapedLayerGraphicOrder))}}function U(r,t){return(t??-Number.MAX_VALUE)-(r??-Number.MAX_VALUE)}function Lt(r){return new rt(r)}class st{constructor(){this.min=new p(u()),this.max=new p(u()),this.hud={min:new $(u()),max:new $(u()),all:new Array},this.ground=new p(u()),this.all=[]}init(t){this.min.init(t),this.max.init(t),this.ground.init(t),this.all.length=0,this.hud.min.init(t),this.hud.max.init(t),this.hud.all.length=0}}class p{get ray(){return this._ray}get distanceInRenderSpace(){return this.dist!=null?(w(A,this.ray.direction,this.dist),S(A)):null}getIntersectionPoint(t){return!!b(this)&&(w(A,this.ray.direction,this.dist),C(t,this.ray.origin,A),!0)}getTransformedNormal(t){return T(g,this.normal),g[3]=0,X(g,g,this.transformation),T(t,g),z(t,t)}constructor(t){this.intersector=l.OBJECT,this.normal=m(),this.transformation=W(),this._ray=u(),this.init(t)}init(t){this.dist=null,this.target=null,this.drapedLayerOrder=null,this.drapedLayerGraphicOrder=null,this.intersector=l.OBJECT,R(t,this._ray)}set(t,s,e,a,o,f,c){this.intersector=t,this.dist=e,T(this.normal,a??H),x(this.transformation,o??j),this.target=s,this.drapedLayerOrder=f,this.drapedLayerGraphicOrder=c}copy(t){R(t.ray,this._ray),this.intersector=t.intersector,this.dist=t.dist,this.target=t.target,this.drapedLayerOrder=t.drapedLayerOrder,this.drapedLayerGraphicOrder=t.drapedLayerGraphicOrder,T(this.normal,t.normal),x(this.transformation,t.transformation)}}class $ extends p{constructor(){super(...arguments),this.intersector=l.HUD}}function _t(r){return new p(r)}const A=m(),g=k();function et(r){return r.type==="point"}class Et{constructor(t,s=null,e=0){this.array=t,this.spatialReference=s,this.offset=e}}function it(r){return"array"in r}function Tt(r,t,s="ground"){if(et(t))return r.getElevation(t.x,t.y,t.z||0,t.spatialReference,s);if(it(t)){let e=t.offset;return r.getElevation(t.array[e++],t.array[e++],t.array[e]||0,t.spatialReference??r.spatialReference,s)}return r.getElevation(t[0],t[1],t[2]||0,r.spatialReference,s)}export{D as E,_t as G,Lt as T,b as a,Tt as b,tt as c,Ot as d,O as e,it as f,pt as g,l as i,yt as o,Et as r,gt as s,et as t};
