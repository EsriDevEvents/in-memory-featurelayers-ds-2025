import{bk as ie,da as Ue,bc as Ge,eA as oe,qV as We,qW as Je,dx as ee,aN as xe,aJ as Te,aL as Ae,ad as W,qX as Le,qY as Re,ay as Ye,aV as Ke,dQ as Ne}from"./index-Dv-JqQDv.js";import{n as Xe,o as A}from"./interfaces-B8ge7Jg9.js";import{a as _e}from"./basicInterfaces-wONHx_SN.js";import{n as Qe,v as Ze,q as et,f as tt,b as rt,u as st}from"./DefaultTechniqueConfiguration-C28-5KBi.js";import{e as it}from"./debugFlags-CfrzpJ7g.js";import{s as q}from"./Util-CQaYQWOS.js";import{e as I}from"./VertexAttribute-BnAa5VW0.js";import{x as Ve,c as Fe,y as nt,u as ot,q as at,i as Pe}from"./BufferView-_0HdWB6j.js";import{o as ce,h as qe}from"./Matrix4PassUniform-B-NXMru_.js";let Gt=class extends Qe{constructor(t){super(t),this._numLoading=0,this._disposed=!1,this._textures=t.textures,this._textureId=t.textureId,this._acquire(t.textureId,i=>this._texture=i),this._acquire(t.normalTextureId,i=>this._textureNormal=i),this._acquire(t.emissiveTextureId,i=>this._textureEmissive=i),this._acquire(t.occlusionTextureId,i=>this._textureOcclusion=i),this._acquire(t.metallicRoughnessTextureId,i=>this._textureMetallicRoughness=i)}dispose(){this._texture=ie(this._texture),this._textureNormal=ie(this._textureNormal),this._textureEmissive=ie(this._textureEmissive),this._textureOcclusion=ie(this._textureOcclusion),this._textureMetallicRoughness=ie(this._textureMetallicRoughness),this._disposed=!0}ensureResources(t){return this._numLoading===0?_e.LOADED:_e.LOADING}get textureBindParameters(){return new ct(this._texture!=null?this._texture.glTexture:null,this._textureNormal!=null?this._textureNormal.glTexture:null,this._textureEmissive!=null?this._textureEmissive.glTexture:null,this._textureOcclusion!=null?this._textureOcclusion.glTexture:null,this._textureMetallicRoughness!=null?this._textureMetallicRoughness.glTexture:null)}updateTexture(t){this._texture!=null&&t===this._texture.id||(this._texture=ie(this._texture),this._textureId=t,this._acquire(this._textureId,i=>this._texture=i))}_acquire(t,i){if(t==null)return void i(null);const r=this._textures.acquire(t);if(Ue(r))return++this._numLoading,void r.then(a=>{if(this._disposed)return ie(a),void i(null);i(a)}).finally(()=>--this._numLoading);i(r)}};class ct extends Xe{constructor(t=null,i=null,r=null,a=null,s=null,n,o){super(),this.texture=t,this.textureNormal=i,this.textureEmissive=r,this.textureOcclusion=a,this.textureMetallicRoughness=s,this.scale=n,this.normalTextureTransformMatrix=o}}class lt{constructor(t=!1,i=!0){this.isVerticalRay=t,this.normalRequired=i}}const ue=Ge();function Jt(e,t,i,r,a,s){if(!e.visible)return;const n=oe(Ee,r,i),o=(u,l,f)=>{s(u,f,l,!1)},c=new lt(!1,t.options.normalRequired);if(e.boundingInfo){q(e.type===it.Mesh);const u=t.tolerance;Ie(e.boundingInfo,i,n,u,a,c,o)}else{const u=e.attributes.get(I.POSITION),l=u.indices;Be(i,n,0,l.length/3,l,u.data,u.stride,a,c,o)}}const ut=W();function Ie(e,t,i,r,a,s,n){if(e==null)return;const o=xt(i,ut);if(We(ue,e.bbMin),Je(ue,e.bbMax),a!=null&&a.applyToAabb(ue),mt(ue,t,o,r)){const{primitiveIndices:c,position:u}=e,l=c?c.length:u.indices.length/3;if(l>St){const f=e.getChildren();if(f!==void 0){for(const w of f)Ie(w,t,i,r,a,s,n);return}}ft(t,i,0,l,u.indices,u.data,u.stride,c,a,s,n)}}const ne=W();function Yt(e,t,i,r,a,s,n,o,c){const{data:u,stride:l}=s;Be(e,oe(Ee,t,e),i,r,a,u,l,n,o,c)}function Kt(e,t,i,r,a,s,n,o,c,u=null,l=0){const f=e[0],w=e[1],V=e[2],M=t[0],L=t[1],S=t[2];for(let R=i;R<r;++R){const _=l+(u?u[R]:R),F=3*_,P=n*a[F],y=s[P],O=s[P+1],v=s[P+2],h=n*a[F+1],g=s[h],x=s[h+1],d=s[h+2],m=n*a[F+2],p=g-y,z=x-O,b=d-v,$=s[m]-y,C=s[m+1]-O,B=s[m+2]-v,H=L*B-C*S,j=S*$-B*M,U=M*C-$*L,T=p*H+z*j+b*U;if(Math.abs(T)<=ge)continue;const D=f-y,k=w-O,G=V-v,N=D*H+k*j+G*U;if(T>0){if(N<0||N>T)continue}else if(N>0||N<T)continue;const J=k*b-z*G,Y=G*p-b*D,K=D*z-p*k,E=M*J+L*Y+S*K;if(T>0){if(E<0||N+E>T)continue}else if(E>0||N+E<T)continue;const X=($*J+C*Y+B*K)/T;X>=0&&c(X,_,o?me(p,z,b,$,C,B,ne):null)}}function Xt(e,t,i,r,a,s,n,o,c,u,l,f=null,w=0){const V=e[0],M=e[1],L=e[2],S=t[0],R=t[1],_=t[2];for(let F=i;F<r;++F){const P=w+(f?f[F]:F),y=3*P,O=n*a[y],v=s[O],h=s[O+1],g=s[O+2],x=n*a[y+1],d=s[x],m=s[x+1],p=s[x+2],z=n*a[y+2],b=s[z],$=s[z+1],C=s[z+2],B=g-c,H=o/Math.sqrt(v*v+h*h+B*B),j=v+v*H,U=h+h*H,T=g+B*H,D=p-c,k=o/Math.sqrt(d*d+m*m+D*D),G=d+d*k,N=m+m*k,J=p+D*k,Y=C-c,K=o/Math.sqrt(b*b+$*$+Y*Y),E=G-j,X=N-U,te=J-T,re=b+b*K-j,Q=$+$*K-U,se=C+Y*K-T,Se=R*se-Q*_,we=_*re-se*S,ze=S*Q-re*R,Z=E*Se+X*we+te*ze;if(Math.abs(Z)<=ge)continue;const he=V-j,ve=M-U,pe=L-T,ae=he*Se+ve*we+pe*ze;if(Z>0){if(ae<0||ae>Z)continue}else if(ae>0||ae<Z)continue;const Oe=ve*te-X*pe,be=pe*E-te*he,$e=he*X-E*ve,le=S*Oe+R*be+_*$e;if(Z>0){if(le<0||ae+le>Z)continue}else if(le>0||ae+le<Z)continue;const ye=(re*Oe+Q*be+se*$e)/Z;ye>=0&&l(ye,P,u?me(E,X,te,re,Q,se,ne):null)}}function ft(e,t,i,r,a,s,n,o,c,u,l){const f=e[0],w=e[1],V=e[2],M=t[0],L=t[1],S=t[2],{normalRequired:R}=u;for(let _=i;_<r;++_){const F=o[_],P=3*F,y=n*a[P];let O=s[y],v=s[y+1],h=s[y+2];const g=n*a[P+1];let x=s[g],d=s[g+1],m=s[g+2];const p=n*a[P+2];let z=s[p],b=s[p+1],$=s[p+2];c!=null&&([O,v,h]=c.applyToVertex(O,v,h,_),[x,d,m]=c.applyToVertex(x,d,m,_),[z,b,$]=c.applyToVertex(z,b,$,_));const C=x-O,B=d-v,H=m-h,j=z-O,U=b-v,T=$-h,D=L*T-U*S,k=S*j-T*M,G=M*U-j*L,N=C*D+B*k+H*G;if(Math.abs(N)<=ge)continue;const J=f-O,Y=w-v,K=V-h,E=J*D+Y*k+K*G;if(N>0){if(E<0||E>N)continue}else if(E>0||E<N)continue;const X=Y*H-B*K,te=K*C-H*J,re=J*B-C*Y,Q=M*X+L*te+S*re;if(N>0){if(Q<0||E+Q>N)continue}else if(Q>0||E+Q<N)continue;const se=(j*X+U*te+T*re)/N;se>=0&&l(se,F,R?me(C,B,H,j,U,T,ne):null)}}function Be(e,t,i,r,a,s,n,o,c,u){const l=t,f=wt,w=Math.abs(l[0]),V=Math.abs(l[1]),M=Math.abs(l[2]),L=w>=V?w>=M?0:2:V>=M?1:2,S=L,R=l[S]<0?2:1,_=(L+R)%3,F=(L+(3-R))%3,P=l[_]/l[S],y=l[F]/l[S],O=1/l[S],v=dt,h=ht,g=vt,{normalRequired:x}=c;for(let d=i;d<r;++d){const m=3*d,p=n*a[m];ee(f[0],s[p+0],s[p+1],s[p+2]);const z=n*a[m+1];ee(f[1],s[z+0],s[z+1],s[z+2]);const b=n*a[m+2];ee(f[2],s[b+0],s[b+1],s[b+2]),o&&(xe(f[0],o.applyToVertex(f[0][0],f[0][1],f[0][2],d)),xe(f[1],o.applyToVertex(f[1][0],f[1][1],f[1][2],d)),xe(f[2],o.applyToVertex(f[2][0],f[2][1],f[2][2],d))),oe(v,f[0],e),oe(h,f[1],e),oe(g,f[2],e);const $=v[_]-P*v[S],C=v[F]-y*v[S],B=h[_]-P*h[S],H=h[F]-y*h[S],j=g[_]-P*g[S],U=g[F]-y*g[S],T=j*H-U*B,D=$*U-C*j,k=B*C-H*$;if((T<0||D<0||k<0)&&(T>0||D>0||k>0))continue;const G=T+D+k;if(G===0)continue;const N=T*(O*v[S])+D*(O*h[S])+k*(O*g[S]);if(N*Math.sign(G)<0)continue;const J=N/G;J>=0&&u(J,d,x?pt(f):null)}}const dt=W(),ht=W(),vt=W();function me(e,t,i,r,a,s,n){return ee(fe,e,t,i),ee(de,r,a,s),Te(n,fe,de),Ae(n,n),n}function pt(e){return oe(fe,e[1],e[0]),oe(de,e[2],e[0]),Te(ne,fe,de),Ae(ne,ne),ne}const fe=W(),de=W();function Qt(e,t,i){return ee(i,1/(t[0]-e[0]),1/(t[1]-e[1]),1/(t[2]-e[2]))}function xt(e,t){return ee(t,1/e[0],1/e[1],1/e[2])}function mt(e,t,i,r){return gt(e,t,i,r,1/0)}function gt(e,t,i,r,a){const s=(e[0]-r-t[0])*i[0],n=(e[3]+r-t[0])*i[0];let o=Math.min(s,n),c=Math.max(s,n);const u=(e[1]-r-t[1])*i[1],l=(e[4]+r-t[1])*i[1];if(c=Math.min(c,Math.max(u,l)),c<0||(o=Math.max(o,Math.min(u,l)),o>c))return!1;const f=(e[2]-r-t[2])*i[2],w=(e[5]+r-t[2])*i[2];return c=Math.min(c,Math.max(f,w)),!(c<0)&&(o=Math.max(o,Math.min(f,w)),!(o>c)&&o<a)}const St=1e3,ge=1e-7,Ee=W(),wt=[W(),W(),W()];function Zt(e,t,i,r=1){const{data:a,indices:s}=e,n=t.typedBuffer,o=t.typedBufferStride,c=s.length;if(i*=o,r===1)for(let u=0;u<c;++u)n[i]=a[s[u]],i+=o;else for(let u=0;u<c;++u){const l=a[s[u]];for(let f=0;f<r;f++)n[i]=l,i+=o}}function Ce(e,t,i){const{data:r,indices:a}=e,s=t.typedBuffer,n=t.typedBufferStride,o=a.length;i*=n;for(let c=0;c<o;++c){const u=2*a[c];s[i]=r[u],s[i+1]=r[u+1],i+=n}}function De(e,t,i,r){const{data:a,indices:s}=e,n=t.typedBuffer,o=t.typedBufferStride,c=s.length;if(i*=o,r==null||r===1)for(let u=0;u<c;++u){const l=3*s[u];n[i]=a[l],n[i+1]=a[l+1],n[i+2]=a[l+2],i+=o}else for(let u=0;u<c;++u){const l=3*s[u];for(let f=0;f<r;++f)n[i]=a[l],n[i+1]=a[l+1],n[i+2]=a[l+2],i+=o}}function ke(e,t,i,r=1){const{data:a,indices:s}=e,n=t.typedBuffer,o=t.typedBufferStride,c=s.length;if(i*=o,r===1)for(let u=0;u<c;++u){const l=4*s[u];n[i]=a[l],n[i+1]=a[l+1],n[i+2]=a[l+2],n[i+3]=a[l+3],i+=o}else for(let u=0;u<c;++u){const l=4*s[u];for(let f=0;f<r;++f)n[i]=a[l],n[i+1]=a[l+1],n[i+2]=a[l+2],n[i+3]=a[l+3],i+=o}}function er(e,t,i){const r=e.typedBuffer,a=e.typedBufferStride;t*=a;for(let s=0;s<i;++s)r[t]=0,r[t+1]=0,r[t+2]=0,r[t+3]=0,t+=a}function zt(e,t,i,r,a=1){if(!t)return void De(e,i,r,a);const{data:s,indices:n}=e,o=i.typedBuffer,c=i.typedBufferStride,u=n.length,l=t[0],f=t[1],w=t[2],V=t[4],M=t[5],L=t[6],S=t[8],R=t[9],_=t[10],F=t[12],P=t[13],y=t[14];r*=c;let O=0,v=0,h=0;const g=Le(t)?x=>{O=s[x]+F,v=s[x+1]+P,h=s[x+2]+y}:x=>{const d=s[x],m=s[x+1],p=s[x+2];O=l*d+V*m+S*p+F,v=f*d+M*m+R*p+P,h=w*d+L*m+_*p+y};if(a===1)for(let x=0;x<u;++x)g(3*n[x]),o[r]=O,o[r+1]=v,o[r+2]=h,r+=c;else for(let x=0;x<u;++x){g(3*n[x]);for(let d=0;d<a;++d)o[r]=O,o[r+1]=v,o[r+2]=h,r+=c}}function Ot(e,t,i,r,a=1){if(!t)return void De(e,i,r,a);const{data:s,indices:n}=e,o=t,c=i.typedBuffer,u=i.typedBufferStride,l=n.length,f=o[0],w=o[1],V=o[2],M=o[4],L=o[5],S=o[6],R=o[8],_=o[9],F=o[10],P=!Re(o),y=1e-6,O=1-y;r*=u;let v=0,h=0,g=0;const x=Le(o)?d=>{v=s[d],h=s[d+1],g=s[d+2]}:d=>{const m=s[d],p=s[d+1],z=s[d+2];v=f*m+M*p+R*z,h=w*m+L*p+_*z,g=V*m+S*p+F*z};if(a===1)if(P)for(let d=0;d<l;++d){x(3*n[d]);const m=v*v+h*h+g*g;if(m<O&&m>y){const p=1/Math.sqrt(m);c[r]=v*p,c[r+1]=h*p,c[r+2]=g*p}else c[r]=v,c[r+1]=h,c[r+2]=g;r+=u}else for(let d=0;d<l;++d)x(3*n[d]),c[r]=v,c[r+1]=h,c[r+2]=g,r+=u;else for(let d=0;d<l;++d){if(x(3*n[d]),P){const m=v*v+h*h+g*g;if(m<O&&m>y){const p=1/Math.sqrt(m);v*=p,h*=p,g*=p}}for(let m=0;m<a;++m)c[r]=v,c[r+1]=h,c[r+2]=g,r+=u}}function bt(e,t,i,r,a=1){if(!t)return void ke(e,i,r,a);const{data:s,indices:n}=e,o=t,c=i.typedBuffer,u=i.typedBufferStride,l=n.length,f=o[0],w=o[1],V=o[2],M=o[4],L=o[5],S=o[6],R=o[8],_=o[9],F=o[10],P=!Re(o),y=1e-6,O=1-y;if(r*=u,a===1)for(let v=0;v<l;++v){const h=4*n[v],g=s[h],x=s[h+1],d=s[h+2],m=s[h+3];let p=f*g+M*x+R*d,z=w*g+L*x+_*d,b=V*g+S*x+F*d;if(P){const $=p*p+z*z+b*b;if($<O&&$>y){const C=1/Math.sqrt($);p*=C,z*=C,b*=C}}c[r]=p,c[r+1]=z,c[r+2]=b,c[r+3]=m,r+=u}else for(let v=0;v<l;++v){const h=4*n[v],g=s[h],x=s[h+1],d=s[h+2],m=s[h+3];let p=f*g+M*x+R*d,z=w*g+L*x+_*d,b=V*g+S*x+F*d;if(P){const $=p*p+z*z+b*b;if($<O&&$>y){const C=1/Math.sqrt($);p*=C,z*=C,b*=C}}for(let $=0;$<a;++$)c[r]=p,c[r+1]=z,c[r+2]=b,c[r+3]=m,r+=u}}function $t(e,t,i,r,a=1){const{data:s,indices:n}=e,o=i.typedBuffer,c=i.typedBufferStride,u=n.length;if(r*=c,t!==s.length||t!==4)if(a!==1)if(t!==4)for(let l=0;l<u;++l){const f=3*n[l];for(let w=0;w<a;++w)o[r]=s[f],o[r+1]=s[f+1],o[r+2]=s[f+2],o[r+3]=255,r+=c}else for(let l=0;l<u;++l){const f=4*n[l];for(let w=0;w<a;++w)o[r]=s[f],o[r+1]=s[f+1],o[r+2]=s[f+2],o[r+3]=s[f+3],r+=c}else{if(t===4){for(let l=0;l<u;++l){const f=4*n[l];o[r]=s[f],o[r+1]=s[f+1],o[r+2]=s[f+2],o[r+3]=s[f+3],r+=c}return}for(let l=0;l<u;++l){const f=3*n[l];o[r]=s[f],o[r+1]=s[f+1],o[r+2]=s[f+2],o[r+3]=255,r+=c}}else{o[r]=s[0],o[r+1]=s[1],o[r+2]=s[2],o[r+3]=s[3];const l=new Uint32Array(i.typedBuffer.buffer,i.start),f=c/4,w=l[r/=4];r+=f;const V=u*a;for(let M=1;M<V;++M)l[r]=w,r+=f}}function yt(e,t,i){const{data:r,indices:a}=e,s=t.typedBuffer,n=t.typedBufferStride,o=a.length,c=r[0];i*=n;for(let u=0;u<o;++u)s[i]=c,i+=n}function _t(e,t,i,r,a=1){const s=t.typedBuffer,n=t.typedBufferStride;if(r*=n,a===1)for(let o=0;o<i;++o)s[r]=e[0],s[r+1]=e[1],s[r+2]=e[2],s[r+3]=e[3],r+=n;else for(let o=0;o<i;++o)for(let c=0;c<a;++c)s[r]=e[0],s[r+1]=e[1],s[r+2]=e[2],s[r+3]=e[3],r+=n}function Ft(e,t,i,r,a,s){var n;for(const o of t.fields.keys()){const c=e.attributes.get(o),u=c==null?void 0:c.indices;if(c&&u)Pt(o,c,i,r,a,s);else if(o===I.OBJECTANDLAYERIDCOLOR&&e.objectAndLayerIdColor!=null){const l=(n=e.attributes.get(I.POSITION))==null?void 0:n.indices;if(l){const f=l.length,w=a.getField(o,Ve);_t(e.objectAndLayerIdColor,w,f,s)}}}}function Pt(e,t,i,r,a,s){switch(e){case I.POSITION:{q(t.size===3);const n=a.getField(e,Pe);q(!!n,`No buffer view for ${e}`),n&&zt(t,i,n,s);break}case I.NORMAL:{q(t.size===3);const n=a.getField(e,Pe);q(!!n,`No buffer view for ${e}`),n&&Ot(t,r,n,s);break}case I.NORMALCOMPRESSED:{q(t.size===2);const n=a.getField(e,at);q(!!n,`No buffer view for ${e}`),n&&Ce(t,n,s);break}case I.UV0:{q(t.size===2);const n=a.getField(e,ot);q(!!n,`No buffer view for ${e}`),n&&Ce(t,n,s);break}case I.COLOR:case I.SYMBOLCOLOR:{const n=a.getField(e,Ve);q(!!n,`No buffer view for ${e}`),q(t.size===3||t.size===4),!n||t.size!==3&&t.size!==4||$t(t,t.size,n,s);break}case I.COLORFEATUREATTRIBUTE:{const n=a.getField(e,nt);q(!!n,`No buffer view for ${e}`),q(t.size===1),n&&t.size===1&&yt(t,n,s);break}case I.TANGENT:{q(t.size===4);const n=a.getField(e,Fe);q(!!n,`No buffer view for ${e}`),n&&bt(t,i,n,s);break}case I.PROFILERIGHT:case I.PROFILEUP:case I.PROFILEVERTEXANDNORMAL:case I.FEATUREVALUE:{q(t.size===4);const n=a.getField(e,Fe);q(!!n,`No buffer view for ${e}`),n&&ke(t,n,s)}}}let tr=class{constructor(t){this.vertexBufferLayout=t}elementCount(t){return t.attributes.get(I.POSITION).indices.length}write(t,i,r,a,s){Ft(r,this.vertexBufferLayout,t,i,a,s)}};function Me(e){e.varyings.add("linearDepth","float")}function Ct(e){e.vertex.uniforms.add(new et("nearFar",(t,i)=>i.camera.nearFar))}function He(e){e.vertex.code.add(A`float calculateLinearDepth(vec2 nearFar,float z) {
return (-z - nearFar[0]) / (nearFar[1] - nearFar[0]);
}`)}function sr(e,t){const{vertex:i}=e;switch(t.output){case ce.Color:if(t.receiveShadows)return Me(e),void i.code.add(A`void forwardLinearDepth() { linearDepth = gl_Position.w; }`);break;case ce.Shadow:case ce.ShadowHighlight:case ce.ShadowExcludeHighlight:case ce.ViewshedShadow:return e.include(Ze,t),Me(e),Ct(e),He(e),void i.code.add(A`void forwardLinearDepth() {
linearDepth = calculateLinearDepth(nearFar, vPosition_view.z);
}`)}i.code.add(A`void forwardLinearDepth() {}`)}function ir(e){He(e),e.vertex.code.add(A`vec4 transformPositionWithDepth(mat4 proj, mat4 view, vec3 pos, vec2 nearFar, out float depth) {
vec4 eye = view * vec4(pos, 1.0);
depth = calculateLinearDepth(nearFar,eye.z);
return proj * eye;
}`),e.vertex.code.add(A`vec4 transformPosition(mat4 proj, mat4 view, vec3 pos) {
return proj * (view * vec4(pos, 1.0));
}`)}function nr(e,t){t.hasVertexColors?(e.attributes.add(I.COLOR,"vec4"),e.varyings.add("vColor","vec4"),e.vertex.code.add(A`void forwardVertexColor() { vColor = color; }`),e.vertex.code.add(A`void forwardNormalizedVertexColor() { vColor = color * 0.003921568627451; }`)):e.vertex.code.add(A`void forwardVertexColor() {}
void forwardNormalizedVertexColor() {}`)}function Mt(e){e.vertex.code.add(A`float screenSizePerspectiveViewAngleDependentFactor(float absCosAngle) {
return absCosAngle * absCosAngle * absCosAngle;
}`),e.vertex.code.add(A`vec3 screenSizePerspectiveScaleFactor(float absCosAngle, float distanceToCamera, vec3 params) {
return vec3(
min(params.x / (distanceToCamera - params.y), 1.0),
screenSizePerspectiveViewAngleDependentFactor(absCosAngle),
params.z
);
}`),e.vertex.code.add(A`float applyScreenSizePerspectiveScaleFactorFloat(float size, vec3 factor) {
return mix(size * clamp(factor.x, factor.z, 1.0), size, factor.y);
}`),e.vertex.code.add(A`float screenSizePerspectiveScaleFloat(float size, float absCosAngle, float distanceToCamera, vec3 params) {
return applyScreenSizePerspectiveScaleFactorFloat(
size,
screenSizePerspectiveScaleFactor(absCosAngle, distanceToCamera, params)
);
}`),e.vertex.code.add(A`vec2 applyScreenSizePerspectiveScaleFactorVec2(vec2 size, vec3 factor) {
return mix(size * clamp(factor.x, factor.z, 1.0), size, factor.y);
}`),e.vertex.code.add(A`vec2 screenSizePerspectiveScaleVec2(vec2 size, float absCosAngle, float distanceToCamera, vec3 params) {
return applyScreenSizePerspectiveScaleFactorVec2(size, screenSizePerspectiveScaleFactor(absCosAngle, distanceToCamera, params));
}`)}function or(e){e.uniforms.add(new qe("screenSizePerspective",t=>je(t.screenSizePerspective)))}function Tt(e){e.uniforms.add(new qe("screenSizePerspectiveAlignment",t=>je(t.screenSizePerspectiveAlignment||t.screenSizePerspective)))}function je(e){return ee(At,e.parameters.divisor,e.parameters.offset,e.minScaleFactor)}const At=W();function ar(e,t){const i=e.vertex;t.hasVerticalOffset?(Rt(i),t.hasScreenSizePerspective&&(e.include(Mt),Tt(i),tt(e.vertex,t)),i.code.add(A`
      vec3 calculateVerticalOffset(vec3 worldPos, vec3 localOrigin) {
        float viewDistance = length((view * vec4(worldPos, 1.0)).xyz);
        ${t.spherical?A`vec3 worldNormal = normalize(worldPos + localOrigin);`:A`vec3 worldNormal = vec3(0.0, 0.0, 1.0);`}
        ${t.hasScreenSizePerspective?A`
            float cosAngle = dot(worldNormal, normalize(worldPos - cameraPosition));
            float verticalOffsetScreenHeight = screenSizePerspectiveScaleFloat(verticalOffset.x, abs(cosAngle), viewDistance, screenSizePerspectiveAlignment);`:A`
            float verticalOffsetScreenHeight = verticalOffset.x;`}
        // Screen sized offset in world space, used for example for line callouts
        float worldOffset = clamp(verticalOffsetScreenHeight * verticalOffset.y * viewDistance, verticalOffset.z, verticalOffset.w);
        return worldNormal * worldOffset;
      }

      vec3 addVerticalOffset(vec3 worldPos, vec3 localOrigin) {
        return worldPos + calculateVerticalOffset(worldPos, localOrigin);
      }
    `)):i.code.add(A`vec3 addVerticalOffset(vec3 worldPos, vec3 localOrigin) { return worldPos; }`)}const Lt=Ke();function Rt(e){e.uniforms.add(new rt("verticalOffset",(t,i)=>{const{minWorldLength:r,maxWorldLength:a,screenLength:s}=t.verticalOffset,n=Math.tan(.5*i.camera.fovY)/(.5*i.camera.fullViewport[3]),o=i.camera.pixelRatio||1;return Ye(Lt,s*o,n,r,a)}))}const Nt=Ne(1,1,0,1),Vt=Ne(1,0,1,1);function cr(e){e.fragment.uniforms.add(new st("depthTexture",(t,i)=>i.mainDepth)),e.fragment.constants.add("occludedHighlightFlag","vec4",Nt).add("unoccludedHighlightFlag","vec4",Vt),e.fragment.code.add(A`void outputHighlight() {
float sceneDepth = float(texelFetch(depthTexture, ivec2(gl_FragCoord.xy), 0).x);
if (gl_FragCoord.z > sceneDepth + 5e-7) {
fragColor = occludedHighlightFlag;
} else {
fragColor = unoccludedHighlightFlag;
}
}`)}export{Pt as A,Xt as B,Qt as C,Ft as E,Ot as O,_t as R,$t as S,cr as a,zt as b,Tt as c,Zt as d,Nt as e,Rt as f,Vt as g,ke as h,nr as i,Ct as j,ar as k,ct as l,lt as m,sr as n,ir as o,Jt as p,mt as q,tr as r,Mt as s,or as t,Gt as u,Me as v,gt as w,Yt as x,er as y,Kt as z};
