import{o as j,i as z,M as G,f as A,h as B}from"./mat3-B7LiNcRs.js";import{e as C}from"./DefaultUI-BWAdHYa0.js";import{t as D}from"./vec2f32-BbH2jxlN.js";import{r as E}from"./vec3f32-Cw9Q6TO_.js";import{hY as H,dH as L}from"./index-Dv-JqQDv.js";import{m as Y}from"./viewpointUtils-CBa44EU3.js";import{a as k,h as q}from"./WGLContainer-m5Dqdi-d.js";import{E as F}from"./Container-BCZInv5n.js";class tt extends k{constructor(){super(...arguments),this._viewStateId=-1,this._dvsMat3=C()}get dvsMat3(){return this._dvsMat3}beforeRender(e){this._updateMatrices(e),this._updateOverlays(e,this.children);for(const r of this.children)r.beforeRender(e)}prepareRenderPasses(e){const r=e.registerRenderPass({name:"overlay",brushes:[q.overlay],target:()=>this.children,drawPhase:F.MAP});return[...super.prepareRenderPasses(e),r]}_updateMatrices(e){const{state:r}=e,{id:s,size:c,pixelRatio:a,resolution:h,rotation:l,viewpoint:M,displayMat3:u}=r;if(this._viewStateId===s)return;const p=Math.PI/180*l,o=a*c[0],n=a*c[1];this._localOrigin=M.targetGeometry.clone();const{x:d,y:_}=this._localOrigin,f=H(d,r.spatialReference);this._localOrigin.x=f,this._localOrigin.y=_;const v=h*o,g=h*n,t=j(this._dvsMat3);z(t,t,u),G(t,t,D(o/2,n/2)),A(t,t,E(o/v,-n/g,1)),B(t,t,-p),this._viewStateId=s}_updateOverlays(e,r){const{state:s}=e,{rotation:c,spatialReference:a,worldScreenWidth:h,size:l,viewpoint:M}=s,u=this._localOrigin;let p,o=0;const n=L(a);if(n&&a.isWrappable){const d=l[0],_=l[1],f=180/Math.PI*c,v=Math.abs(Math.cos(f)),g=Math.abs(Math.sin(f)),t=Math.round(d*v+_*g),[x,b]=n.valid,i=Y(a),{x:O,y:I}=M.targetGeometry,S=[O,I],w=[0,0];s.toScreen(w,S);const m=[0,0];let y;y=t>h?.5*h:.5*t;const P=Math.floor((O+.5*i)/i),$=x+P*i,W=b+P*i,R=[w[0]+y,0];s.toMap(m,R),m[0]>W&&(o=i),R[0]=w[0]-y,s.toMap(m,R),m[0]<$&&(o=-i),p={worldWidth:i,xBounds:[x,b]}}for(const d of r)d.updateDrawCoords(u,o,a,p)}}export{tt as f};
